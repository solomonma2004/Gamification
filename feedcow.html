<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°æ˜¥è‚¥ç‰›é£¼é¤Šå¤§è³½ | Cow Raising Contest</title>
    <!-- CSS & Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F0F8FF; }
        .cow-image-container {
            width: 100%; aspect-ratio: 4 / 3; position: relative; overflow: hidden;
            border-radius: 0.75rem; background-color: #f3f4f6; border: 4px solid #fff; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .cow-image-container img { width: 100%; height: 100%; object-fit: contain; transition: transform 0.3s ease; }
        .cow-image-container:hover img { transform: scale(1.05); }
        .fence-bg {
            background-color: #81C784;
            background-image: radial-gradient(#A5D6A7 15%, transparent 16%), radial-gradient(#A5D6A7 15%, transparent 16%);
            background-size: 20px 20px; background-position: 0 0, 10px 10px;
        }
        .rank-badge { display: flex; align-items: center; justify-content: center; font-weight: 900; box-shadow: 0 4px 8px rgba(0,0,0,0.4); z-index: 50; }
        .brand-badge { font-size: 0.75rem; padding: 4px 10px; border-radius: 9999px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        .brand-Dermes { background-color: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; }
        .brand-Reenex { background-color: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }
        .brand-Elyze { background-color: #fdf4ff; color: #a21caf; border: 1px solid #f5d0fe; }
        .tab-active-Dermes { background-color: #0369a1; color: white; border-color: #0369a1; }
        .tab-active-Reenex { background-color: #15803d; color: white; border-color: #15803d; }
        .tab-active-Elyze { background-color: #a21caf; color: white; border-color: #a21caf; }
        
        .strength-bar { 
            position: absolute; left: 0; top: 0; height: 100%; opacity: 0.25; 
            transition: width 1.2s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 0; 
        }
        
        @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-modal { animation: modalFadeIn 0.2s ease-out forwards; }
    </style>
</head>
<body class="pb-6 overflow-x-hidden">

    <!-- å…¨åŸŸè®Šæ•¸é å®šç¾©ï¼Œé˜²æ­¢ ReferenceError -->
    <script>
        window.currentLang = 'zh';
        window.currentRankBrand = 'Dermes';
    </script>

    <!-- Language Switcher -->
    <div class="fixed top-4 right-4 z-[100] flex gap-1 bg-white/90 backdrop-blur-md p-1.5 rounded-full shadow-2xl border border-gray-100">
        <button onclick="changeLanguage('zh')" id="btn-zh" class="px-4 py-1.5 rounded-full text-sm font-black transition-all bg-red-600 text-white shadow-md">ä¸­</button>
        <button onclick="changeLanguage('en')" id="btn-en" class="px-4 py-1.5 rounded-full text-sm font-black text-gray-500 hover:bg-gray-50">EN</button>
    </div>

    <!-- Header Image -->
    <div class="relative w-screen ml-[calc(-50vw+50%)]">
        <img src="https://i.postimg.cc/dVZ3Wyrh/Whats-App-Image-2026-01-16-at-13-05-41.jpg" alt="Poster" class="w-full h-auto block">
    </div>

    <!-- Intro Header Section -->
    <div class="relative w-screen ml-[calc(-50vw+50%)] shadow-2xl overflow-hidden bg-red-900 group flex items-center justify-center py-8 border-b-4 border-yellow-500 text-center md:text-left">
        <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-red-800 to-red-950 z-0"></div>
        <div class="absolute -top-1/2 -left-1/4 w-[150%] h-[200%] bg-red-600 rotate-12 transform origin-bottom-left opacity-20 animate-pulse"></div>
        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-30 mix-blend-overlay"></div>
        <div class="relative z-10 w-full max-w-7xl px-4 sm:px-8 md:px-20 text-white flex flex-col md:flex-row items-center justify-between gap-6 md:gap-10">
            <div class="flex-1 flex flex-col justify-center space-y-2">
                <div class="inline-flex items-center justify-center md:justify-start gap-2 mb-1">
                    <span class="h-2 w-10 bg-yellow-400 rounded-full"></span>
                    <span id="txt-utilize-ai" class="text-yellow-300 font-black tracking-[0.15em] text-sm uppercase">åˆ©ç”¨ AI å°åº—</span>
                </div>
                <h2 class="text-5xl sm:text-6xl lg:text-8xl font-black leading-none drop-shadow-2xl tracking-tighter">
                    <span id="txt-make">ä»¤</span><span class="text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 via-orange-300 to-yellow-300 animate-pulse">20,000</span><span id="txt-cust">å®¢äºº</span>
                </h2>
                <p id="txt-best-promoter" class="text-2xl sm:text-3xl font-black opacity-90 tracking-widest text-yellow-50 uppercase mt-1">è®Šæˆæœ€å¼·æ¨å»£è€…</p>
                <div class="mt-4 inline-block bg-white/10 backdrop-blur-md border border-white/20 px-6 py-3 rounded-2xl shadow-xl">
                    <p id="txt-banner-slogan" class="text-2xl sm:text-3xl font-black text-yellow-400 tracking-wider">åšä»»å‹™è´å–é£¼æ–™ å„²ç³§é¤Šè‚¥ç‰›</p>
                </div>
            </div>
            <div class="flex-1 flex flex-col items-center md:items-end justify-center mt-4 md:mt-0">
                <div class="relative">
                    <div class="text-[7rem] sm:text-[10rem] lg:text-[12rem] font-black text-white/5 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-0 select-none blur-sm">Promoter</div>
                    <div class="relative z-10 text-7xl sm:text-8xl lg:text-9xl font-black text-white flex items-baseline gap-1 drop-shadow-2xl leading-none italic">Promoter<span class="text-4xl sm:text-6xl text-yellow-400 font-black animate-bounce">!</span></div>
                </div>
                <div id="txt-event-title" class="text-lg sm:text-xl font-black bg-yellow-500 text-red-900 px-6 py-2 mt-4 transform -skew-x-12 inline-block shadow-2xl uppercase tracking-widest border-2 border-red-700/20">å…¨æ°‘é¤Šç‰› â€¢ ç©å‡ºè±ç››</div>
            </div>
        </div>
    </div>

    <!-- Top 10 Leaderboard -->
    <section class="px-2 pb-12 relative z-0 fence-bg pt-12 shadow-inner text-center">
        <div class="w-full max-w-[98%] mx-auto relative z-10">
           <div class="flex flex-col items-center justify-center gap-4 mb-14">
                <div class="flex items-center gap-6 bg-white/25 backdrop-blur-md px-10 md:px-16 py-6 md:py-10 rounded-[4rem] border-2 border-white/60 shadow-2xl transition-all duration-500 hover:scale-[1.02]">
                    <i data-lucide="trophy" class="w-12 h-12 md:w-24 md:h-24 text-yellow-300 drop-shadow-[0_0_25px_rgba(253,224,71,0.7)]"></i>
                    <h2 id="txt-leaderboard-title" class="font-black text-white text-5xl md:text-9xl tracking-tighter drop-shadow-[0_4px_10px_rgba(0,0,0,0.4)]">è‚¥ç‰›ç‰§å ´æ’è¡Œæ¦œ</h2>
                </div>
                <div class="bg-red-600/90 text-white px-12 py-3 rounded-full text-3xl md:text-5xl tracking-[0.6em] font-black animate-pulse mt-8 shadow-2xl border-4 border-red-300/40">LIVE UPDATE</div>
           </div>

           <div id="loading-indicator" class="flex flex-col items-center justify-center py-16">
               <div class="w-16 h-16 border-8 border-yellow-400 border-t-transparent rounded-full animate-spin mb-6"></div>
               <p id="txt-loading" class="text-white text-2xl font-black animate-pulse tracking-widest">æ­£åœ¨è®€å–ç‰§å ´æ•¸æ“š...</p>
           </div>

           <div id="leaderboard-grid" class="grid grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-16 px-2 lg:px-16"></div>
        </div>
    </section>

    <!-- Brand Floor Ranking & Distribution Diagram -->
    <section class="px-2 py-20 relative z-10 bg-white border-t border-b border-gray-100 shadow-sm overflow-hidden">
        <div class="max-w-5xl mx-auto">
            <div class="text-center mb-10 px-4">
                <h3 id="txt-floor-rank-title" class="text-4xl md:text-7xl font-black text-gray-800 flex flex-col items-center justify-center gap-3 leading-tight tracking-tighter">
                    <i data-lucide="bar-chart-3" class="w-14 h-14 md:w-20 md:h-20 text-blue-600"></i>å“ç‰Œæ¨“å±¤å¹³å‡å¯¦åŠ›æ¦œ
                </h3>
                <div class="flex items-center justify-center gap-6 mt-8">
                    <div class="h-1.5 w-16 md:w-32 bg-blue-200 rounded-full"></div>
                    <button onclick="toggleMissionModal(true)" class="flex items-center gap-3 px-8 py-3 rounded-full bg-blue-600 text-white hover:bg-blue-700 transition-all shadow-2xl active:scale-95 group border-2 border-blue-400/30">
                        <i data-lucide="info" class="w-6 h-6 fill-white/20"></i>
                        <span class="font-black text-base md:text-lg tracking-widest uppercase" id="txt-btn-explain">åœ–æ¨™èªªæ˜</span>
                    </button>
                    <div class="h-1.5 w-16 md:w-32 bg-blue-200 rounded-full"></div>
                </div>
            </div>

            <!-- Brand Selection Tabs -->
            <div class="flex justify-center p-2 bg-gray-200/50 rounded-[2.5rem] mb-12 shadow-inner max-w-md mx-auto border border-gray-200/80">
                <button onclick="switchRankBrand('Dermes')" id="tab-Dermes" class="flex-1 py-4 px-2 rounded-[2rem] text-sm md:text-lg font-black transition-all tab-active-Dermes shadow-xl">Dermes</button>
                <button onclick="switchRankBrand('Reenex')" id="tab-Reenex" class="flex-1 py-4 px-2 rounded-[2rem] text-sm md:text-lg font-black transition-all text-gray-500">Reenex</button>
                <button onclick="switchRankBrand('Elyze')" id="tab-Elyze" class="flex-1 py-4 px-2 rounded-[2rem] text-sm md:text-lg font-black transition-all text-gray-500">Elyze</button>
            </div>

            <!-- Tab 1: Ranking View -->
            <div id="floor-ranking-content" class="space-y-8 px-2"></div>

            <!-- Tab 2: Distribution Diagram (NEW SECTION) -->
            <div class="mt-20 pt-16 border-t border-gray-100">
                <div class="text-center mb-10">
                    <h4 id="txt-dist-title" class="text-3xl md:text-5xl font-black text-gray-800 flex items-center justify-center gap-3">
                        <i data-lucide="pie-chart" class="w-10 h-10 text-orange-500"></i>æ¨“å±¤ç‰›éš»ç­‰ç´šåˆ†ä½ˆåœ–
                    </h4>
                    <p id="txt-dist-sub" class="text-gray-400 font-bold mt-2 uppercase tracking-widest text-xs">Floor Level Distribution</p>
                </div>
                
                <!-- Legend for Diagram -->
                <div class="flex flex-wrap justify-center gap-3 mb-8 px-4">
                    <div class="flex items-center gap-1.5 px-3 py-1 bg-gray-100 rounded-full text-[10px] font-bold text-gray-500"><span class="w-2.5 h-2.5 bg-gray-400 rounded-full"></span> ç˜¦ç‰›</div>
                    <div class="flex items-center gap-1.5 px-3 py-1 bg-green-50 rounded-full text-[10px] font-bold text-green-700 border border-green-100"><span class="w-2.5 h-2.5 bg-green-500 rounded-full"></span> æ¾³æ´²ç‰›</div>
                    <div class="flex items-center gap-1.5 px-3 py-1 bg-blue-50 rounded-full text-[10px] font-bold text-blue-700 border border-blue-100"><span class="w-2.5 h-2.5 bg-blue-500 rounded-full"></span> ç¾åœ‹ç‰›</div>
                    <div class="flex items-center gap-1.5 px-3 py-1 bg-purple-50 rounded-full text-[10px] font-bold text-purple-700 border border-purple-100"><span class="w-2.5 h-2.5 bg-purple-500 rounded-full"></span> æ—¥æœ¬å’Œç‰›</div>
                    <div class="flex items-center gap-1.5 px-3 py-1 bg-yellow-50 rounded-full text-[10px] font-bold text-yellow-700 border border-yellow-200"><span class="w-2.5 h-2.5 bg-yellow-500 rounded-full"></span> é‡‘ç‰›</div>
                </div>

                <div id="floor-distribution-content" class="space-y-6 px-2">
                    <!-- JS Injected Diagram Rows -->
                </div>
            </div>
        </div>
    </section>

    <!-- Mission Legend Modal -->
    <div id="mission-modal" class="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/80 backdrop-blur-md hidden" onclick="toggleMissionModal(false)">
        <div class="bg-white rounded-[3rem] w-full max-w-md p-10 shadow-[0_30px_60px_rgba(0,0,0,0.5)] animate-modal border-2 border-blue-50" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-8">
                <h4 id="txt-modal-title" class="text-2xl font-black text-gray-800 flex items-center gap-3 uppercase tracking-tight">ä»»å‹™åœ–æ¨™èªªæ˜</h4>
                <button onclick="toggleMissionModal(false)" class="text-gray-400 hover:text-red-500 transition-colors"><i data-lucide="x-circle" class="w-10 h-10"></i></button>
            </div>
            <div class="space-y-5">
                <div class="flex items-start gap-5 p-5 rounded-[1.8rem] bg-orange-50/50 border border-orange-100 shadow-sm">
                    <span class="text-4xl">ğŸ‘€</span><div><div class="text-[11px] text-orange-600 font-black uppercase tracking-widest mb-0.5">Task 1</div><div id="txt-modal-task1" class="text-base font-black text-gray-700 leading-tight">æ–°å¢ 5 å€‹è‡ªå·±å°åº—è¿½è¹¤è€…</div></div>
                </div>
                <div class="flex items-start gap-5 p-5 rounded-[1.8rem] bg-orange-50/50 border border-orange-100 shadow-sm">
                    <span class="text-4xl">ğŸª</span><div><div class="text-[11px] text-orange-600 font-black uppercase tracking-widest mb-0.5">Task 2</div><div id="txt-modal-task2" class="text-base font-black text-gray-700 leading-tight">æ–°å¢ä¸€å€‹ACBæˆç‚ºåº—ä¸»</div></div>
                </div>
                <div class="flex items-start gap-5 p-5 rounded-[1.8rem] bg-orange-50/50 border border-orange-100 shadow-sm">
                    <span class="text-4xl">ğŸ§§</span><div><div class="text-[11px] text-orange-600 font-black uppercase tracking-widest mb-0.5">Task 3</div><div id="txt-modal-task3" class="text-base font-black text-gray-700 leading-tight">å®¢äººç”±è‡ªå·±å°åº—æ¶å¾—åˆ©æ˜¯ (æœ€å¤šé ˜å–25æ¬¡)</div></div>
                </div>
                <div class="flex items-start gap-5 p-5 rounded-[1.8rem] bg-orange-50/50 border border-orange-100 shadow-sm">
                    <span class="text-4xl">ğŸ¤</span><div><div class="text-[11px] text-orange-600 font-black uppercase tracking-widest mb-0.5">Task 4</div><div id="txt-modal-task4" class="text-base font-black text-gray-700 leading-tight">æˆåŠŸé©…å‹•ACBé‚€è«‹å¥½å‹è‡³å…¶å°åº—åƒèˆ‡ã€Œæ¶åˆ©æ˜¯ã€æ´»å‹•ä¸¦ç²è´ˆ$1,888 ç¦®åˆ¸ã€‚</div></div>
                </div>
            </div>
            <button onclick="toggleMissionModal(false)" id="txt-modal-close" class="w-full mt-10 py-5 bg-blue-600 text-white rounded-2xl text-xl font-black shadow-2xl shadow-blue-200 active:scale-95 transition-all">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <!-- Evolution Guide -->
    <section class="px-3 py-16 relative z-10 bg-[#FFF3E0]">
        <div class="max-w-lg mx-auto">
             <div class="mb-14 shadow-2xl rounded-3xl overflow-hidden border-4 border-[#8D6E63] bg-white relative">
                 <h4 class="font-black text-[#5D4037] text-2xl p-5 bg-[#FFECB3] border-b-2 border-[#8D6E63] flex items-center justify-center gap-3 tracking-wide uppercase">
                    <i data-lucide="award" class="w-8 h-8 text-yellow-700"></i> <span id="txt-tier-title">ç‰›ç‰›é€²åŒ–éšç´šèˆ‡çé …</span>
                 </h4>
                 <div id="tier-list-container" class="p-6 space-y-6 relative z-10"></div>
             </div>
             <div class="bg-white rounded-[2.5rem] p-8 shadow-2xl border-4 border-orange-200 mb-8 relative overflow-hidden">
                 <h4 class="font-black text-orange-900 text-2xl mb-8 flex items-center gap-4 border-b-2 border-orange-100 pb-4">
                    <i data-lucide="flame" class="w-8 h-8 text-red-500 fill-red-500"></i> <span id="txt-feed-guide-title">é£¼æ–™ç²å–æ”»ç•¥</span>
                 </h4>
                 <div id="tasks-container" class="space-y-6"></div>
                 <div class="mt-10 bg-gradient-to-br from-orange-100 via-orange-50 to-orange-100 rounded-3xl p-6 text-center shadow-inner border border-orange-200">
                     <div class="flex justify-around items-center">
                         <div class="flex flex-col"><span id="txt-start-weight-label" class="text-xs text-orange-800 font-black uppercase tracking-widest">èµ·å§‹é«”é‡</span><span class="text-3xl font-black text-red-600">300kg</span></div>
                         <div class="h-12 w-0.5 bg-orange-300/50"></div>
                         <div class="flex flex-col"><span id="txt-ratio-label" class="text-xs text-orange-800 font-black uppercase tracking-widest">æˆé•·æ›ç®—</span><span id="txt-ratio-value" class="text-3xl font-black text-orange-700">1ä»½ = +5kg</span></div>
                     </div>
                </div>
             </div>
        </div>
    </section>

    <!-- Search Section -->
    <section class="px-4 py-16 bg-white border-t border-gray-100 relative shadow-inner">
         <div class="max-w-md mx-auto">
             <h2 class="text-center font-black text-gray-800 text-2xl mb-8 flex items-center justify-center gap-3">
                 <i data-lucide="search" class="w-8 h-8 text-red-500"></i> <span id="txt-search-title">æœå°‹æˆ‘çš„ç‰›ç‰›</span>
             </h2>
             <div class="grid grid-cols-2 gap-3 mb-4">
                 <select id="brand-filter" class="block w-full px-4 py-3 border-2 border-gray-200 rounded-2xl text-base bg-gray-50 text-gray-700 focus:border-red-500 font-black appearance-none">
                    <option id="opt-all-brands" value="">æ‰€æœ‰å“ç‰Œ</option>
                    <option value="Dermes">Dermes</option>
                    <option value="Reenex">Reenex</option>
                    <option value="Elyze">Elyze</option>
                 </select>
                 <select id="location-filter" class="block w-full px-4 py-3 border-2 border-gray-200 rounded-2xl text-base bg-gray-50 text-gray-700 focus:border-red-500 font-black appearance-none">
                    <option id="opt-all-locations" value="">æ‰€æœ‰æ¨“å±¤</option>
                 </select>
             </div>
             <div class="relative mb-8">
                 <select id="user-select" class="block w-full px-5 py-4 border-2 border-red-100 rounded-[1.5rem] bg-white text-gray-900 focus:border-red-500 font-black shadow-lg appearance-none">
                 </select>
             </div>
             
             <!-- Card -->
             <div id="user-card" class="bg-[#FFF8E1] rounded-[2.5rem] p-6 border-4 border-[#8D6E63] relative hidden shadow-2xl">
                <div class="absolute top-4 left-4 w-3 h-3 rounded-full bg-[#5D4037]"></div><div class="absolute top-4 right-4 w-3 h-3 rounded-full bg-[#5D4037]"></div><div class="absolute bottom-4 left-4 w-3 h-3 rounded-full bg-[#5D4037]"></div><div class="absolute bottom-4 right-4 w-3 h-3 rounded-full bg-[#5D4037]"></div>
                <div class="flex justify-between items-start mb-6">
                    <div><div class="flex gap-2 mb-2"><span id="card-brand" class="brand-badge text-xs">BRAND</span><span id="card-location" class="bg-[#8D6E63] text-white px-3 py-1 rounded-full text-xs font-black shadow-sm">LOC</span></div><h3 id="card-name" class="text-3xl font-black text-[#3E2723] tracking-tighter">å§“å</h3></div>
                    <span id="card-rank" class="bg-yellow-400 text-yellow-900 px-4 py-2 rounded-2xl text-2xl font-black shadow-xl transform rotate-3 border-4 border-white ring-2 ring-yellow-300"># -</span>
                </div>
                <div class="cow-image-container mb-6 border-4 border-white shadow-xl rounded-2xl"><img id="card-cow-img" src="" alt="Cow Image" onerror="this.src='https://placehold.co/640x480?text=Loading';"></div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-3xl text-center border-2 border-[#FFE082] shadow-md"><span id="txt-card-weight-label" class="block text-[11px] text-[#8D6E63] font-black uppercase tracking-widest mb-1">ç›®å‰é«”é‡</span><span id="card-weight" class="block text-2xl font-black text-red-600">0kg</span></div>
                    <div class="bg-white p-4 rounded-3xl text-center border-2 border-[#FFE082] shadow-md"><span id="txt-card-feed-label" class="block text-[11px] text-[#8D6E63] font-black uppercase tracking-widest mb-1">ç´¯ç©é£¼æ–™</span><span id="card-feeds" class="block text-2xl font-black text-orange-500">0ä»½</span></div>
                </div>
                <div id="unlocked-reward-panel" class="bg-yellow-50/80 rounded-3xl p-5 border-2 border-yellow-200 mb-6 flex items-center gap-4 shadow-inner">
                    <div class="w-12 h-12 bg-yellow-400 rounded-2xl flex items-center justify-center shrink-0 shadow-lg border-2 border-white"><i data-lucide="gift" class="w-7 h-7 text-white"></i></div>
                    <div><div class="text-[10px] text-yellow-700 font-black uppercase tracking-[0.2em] mb-1"><span id="txt-unlocked-title">ç›®å‰å¯ç²çå‹µ</span></div><div id="card-reward-name" class="text-base font-black text-gray-800 leading-tight">Reward Info</div></div>
                </div>
                <div class="bg-white rounded-3xl p-5 border-2 border-[#FFE082] mb-6 shadow-md">
                    <div class="flex justify-between text-sm font-black text-[#5D4037] mb-2"><span id="card-level-title">ç­‰ç´š</span><span id="card-next-level" class="text-red-500 italic">ä¸‹ç´šç›®æ¨™</span></div>
                    <div class="w-full bg-gray-100 rounded-full h-4 overflow-hidden mb-2 border border-gray-200 shadow-inner"><div id="card-progress-bar" class="bg-gradient-to-r from-green-400 via-green-500 to-green-600 h-full transition-all duration-1000 shadow-inner"></div></div>
                    <p id="card-diff-text" class="text-xs text-center text-gray-500 font-bold">åŠªåŠ›ä¸­...</p>
                </div>
                <div class="border-t-4 border-[#D7CCC8] pt-6 border-dashed">
                    <h4 class="text-center font-black text-[#5D4037] text-sm mb-4 flex items-center justify-center gap-2 bg-[#D7CCC8]/30 py-2 rounded-full mx-auto w-max px-6 uppercase tracking-widest"><i data-lucide="clipboard-list" class="w-4 h-4"></i> <span id="txt-report-card-title">ä»»å‹™æˆç¸¾å–®</span></h4>
                    <div id="card-tasks-grid" class="grid grid-cols-2 gap-3 text-[11px]"></div>
                </div>
             </div>
         </div>
    </section>

    <footer class="text-center text-gray-400 text-xs py-10 tracking-widest font-bold opacity-60">Â© 2026 Neoderm New Year Event</footer>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwFLJr6n8QGwaDb-hBjC6xOwd2ANzDyW1b-iInQfQkxZEDDmP1U6F5lJampP6JNWjR6/exec'; 

        const i18n = {
            zh: {
                utilizeAi: "åˆ©ç”¨ AI å°åº—", make: "ä»¤", cust: "å®¢äºº", bestPromoter: "è®Šæˆæœ€å¼·æ¨å»£è€…",
                bannerSlogan: "åšä»»å‹™è´å–é£¼æ–™ å„²ç³§é¤Šè‚¥ç‰›", eventTitle: "å…¨æ°‘é¤Šç‰› â€¢ ç©å‡ºè±ç››",
                leaderboardTitle: "è‚¥ç‰›ç‰§å ´æ’è¡Œæ¦œ", loading: "æ­£åœ¨è®€å–ç‰§å ´æ•¸æ“š...",
                tierTitle: "ç‰›ç‰›é€²åŒ–éšç´šèˆ‡çé …", feedGuideTitle: "é£¼æ–™ç²å–æ”»ç•¥",
                startWeightLabel: "èµ·å§‹é«”é‡", ratioLabel: "æˆé•·æ›ç®—", ratioValue: "1ä»½ = +5kg",
                searchTitle: "æœå°‹æˆ‘çš„ç‰›ç‰›", allBrands: "æ‰€æœ‰å“ç‰Œ", allLocations: "æ‰€æœ‰æ¨“å±¤",
                cardWeightLabel: "ç›®å‰é«”é‡", cardFeedLabel: "ç´¯ç©é£¼æ–™", reportCardTitle: "ä»»å‹™æˆç¸¾å–®",
                task1: "æ–°å¢ 5 å€‹è‡ªå·±å°åº—è¿½è¹¤è€…", 
                task2: "æ–°å¢ä¸€å€‹ACBæˆç‚ºåº—ä¸»",
                task3: "å®¢äººç”±è‡ªå·±å°åº—æ¶å¾—åˆ©æ˜¯ (æœ€å¤šé ˜å–25æ¬¡)", 
                task4: "æˆåŠŸé©…å‹•ACBé‚€è«‹å¥½å‹è‡³å…¶å°åº—åƒèˆ‡ã€Œæ¶åˆ©æ˜¯ã€æ´»å‹•ä¸¦ç²è´ˆ$1,888 ç¦®åˆ¸ã€‚",
                tLabel1: "æ–°å¢è¿½è¹¤", tLabel2: "ACBåº—ä¸»", tLabel3: "æ¶åˆ©æ˜¯", tLabel4: "é©…å‹•ACB",
                goal: "ç›®æ¨™", maxLevel: "å·²é”æœ€é«˜ç´š", feedsToUpgrade: "å°šæ¬  {n} ä»½é£¼æ–™å‡ç´š",
                congrats: "æ­å–œï¼æ‚¨å·²é¤Šå‡ºé‡‘ç‰›ï¼", noMatch: "æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„åŒäº‹",
                tierUltimate: "æœ€çµ‚æ¥µå¤§ç â€¢ æ¦®è€€å·”å³°", tierBottom: "åŠªåŠ›åŠ é¤é£¯ï¼Œè„«é›¢ç˜¦å¼±ï¼",
                rewardLabel: "çå“å…§å®¹", valueLabel: "åƒ¹å€¼", unlockedTitle: "ç›®å‰å¯ç²çå‹µ",
                floorRankTitle: "å“ç‰Œæ¨“å±¤å¹³å‡å¯¦åŠ›æ¦œ", avgWeight: "å¹³å‡é«”é‡",
                modalTitle: "ä»»å‹™åœ–æ¨™èªªæ˜", modalClose: "æˆ‘çŸ¥é“äº†", btnExplain: "åœ–æ¨™èªªæ˜",
                distTitle: "æ¨“å±¤ç‰›éš»ç­‰ç´šåˆ†ä½ˆåœ–"
            },
            en: {
                utilizeAi: "Utilizing AI Shop", make: "Turning", cust: "Customers", bestPromoter: "Into Strong Promoters",
                bannerSlogan: "Complete Tasks to Earn Feed & Grow Your Cow", eventTitle: "Raising Fat Cows â€¢ A Prosperous New Year",
                leaderboardTitle: "Fat Cow Ranch Ranking", loading: "Loading ranch data...",
                tierTitle: "Cow Evolution Tiers & Prizes", feedGuideTitle: "Feed Acquisition Guide",
                startWeightLabel: "Starting Weight", ratioLabel: "Conversion", ratioValue: "1 Feed = +5kg",
                searchTitle: "Search My Cow", allBrands: "All Brands", allLocations: "All Floors",
                cardWeightLabel: "Current Weight", cardFeedLabel: "Total Feeds", reportCardTitle: "Task Report Card",
                task1: "Add 5 shop followers", 
                task2: "Add one ACB as a shop owner",
                task3: "Customer gets red packet from shop (Max 25 times)", 
                task4: "Successfully drive ACB to invite friends to their shop for 'Red Packet' event and receive $1,888 voucher.",
                tLabel1: "New Follows", tLabel2: "ACB Owners", tLabel3: "Packets", tLabel4: "Drive ACB",
                goal: "Goal", maxLevel: "Max Level Reached", feedsToUpgrade: "{n} feeds needed to upgrade",
                congrats: "Congrats! You raised a Golden Cow!", noMatch: "No matching colleagues found",
                tierUltimate: "Grand Prize â€¢ Peak of Honor", tierBottom: "Keep eating to leave the lean stage!",
                rewardLabel: "Reward", valueLabel: "Value", unlockedTitle: "Current Eligible Reward",
                floorRankTitle: "Brand Floor Average Ranking", avgWeight: "Avg Weight",
                modalTitle: "Mission Icon Legend", modalClose: "Got it", btnExplain: "Legend",
                distTitle: "Floor Level Distribution"
            }
        };

        const MILESTONES = [
            { min: 300, max: 499, title: {zh: "ç˜¦ç‰›", en: "Lean Cow"}, color: "text-gray-500", barColor: "bg-gray-400", skin: "#A1887F", img: "https://i.postimg.cc/pdy5zLJq/Whats-App-Image-2026-01-16-at-15-00-48.jpg", reward: { zh: "ç¹¼çºŒåŠªåŠ›ï¼åŠ æ²¹ï¼", en: "Keep trying!" }, value: "" }, 
            { min: 500, max: 599, title: {zh: "ä¿¡æœ›æ„›æ¾³æ´²ç‰›", en: "FHL Australian Beef"}, color: "text-green-700", barColor: "bg-green-500", skin: "#795548", img: "https://i.postimg.cc/52sFXCLL/Whats-App-Image-2026-01-16-at-15-01-13.jpg", reward: { zh: "Bicelle B5 3D MASK X5", en: "Bicelle B5 3D MASK X5" }, value: "$299" }, 
            { min: 600, max: 699, title: {zh: "å…¬ç¾©ç¾åœ‹ç©€é£¼ç‰›", en: "Righteous US Beef"}, color: "text-blue-700", barColor: "bg-blue-500", skin: "#5D4037", img: "https://i.postimg.cc/9QLqD7ZP/Whats-App-Image-2026-01-16-at-15-00-50.jpg", reward: { zh: "Exuviance é«˜æ•ˆèƒ½çµ„åˆ AP25", en: "Exuviance AP25 Kit" }, value: "$520" }, 
            { min: 700, max: 799, title: {zh: "å¹³å®‰æ—¥æœ¬å’Œç‰›", en: "Japanese Wagyu"}, color: "text-purple-700", barColor: "bg-purple-500", skin: "#212121", img: "https://i.postimg.cc/Bnm1jKH1/Whats-App-Image-2026-01-16-at-15-00-49.jpg", reward: { zh: "Celluion æ´»æ€§è† åŸçµ„åˆ", en: "Celluion Collagen Kit" }, value: "$1,800" }, 
            { min: 800, max: 99999, title: {zh: "å–œæ¨‚è±ç››é‡‘ç‰›", en: "Abundant Golden Cow"}, color: "text-yellow-700 font-black", barColor: "bg-yellow-500", skin: "#FFD700", img: "https://i.postimg.cc/2S0B1Zhv/Whats-App-Image-2026-01-16-at-15-00-49-(1).jpg", reward: { zh: "Celluion è¶…è²æ³¢ PLLA 5å¥—è£", en: "Celluion Ultrasonic PLLA" }, value: "$2,860" } 
        ];

        // --- Core Helpers ---
        function getCowStatus(weight) { return MILESTONES.find(m => weight >= m.min && weight <= m.max) || MILESTONES[0]; }
        function getNextMilestone(weight) { return MILESTONES.find(m => m.min > weight); }
        function calculateStats(t1, t2, t3, t4) {
            const cappedT3 = Math.min(25, t3);
            const totalFeeds = (t1 * 1) + (t2 * 2) + (cappedT3 * 2) + (t4 * 3);
            return { totalFeeds, weight: 300 + (totalFeeds * 5) };
        }
        function getProp(obj, names) {
            for (let name of names) { if (obj[name] !== undefined) { const val = obj[name]; return typeof val === 'string' ? val.trim() : val; } }
            return "";
        }
        function toggleMissionModal(show) {
            const modal = document.getElementById('mission-modal');
            if(!modal) return;
            if (show) modal.classList.remove('hidden');
            else modal.classList.add('hidden');
        }

        // --- UI Rendering ---
        function updateUI() {
            const lang = i18n[window.currentLang];
            
            document.getElementById('txt-utilize-ai').textContent = lang.utilizeAi;
            document.getElementById('txt-make').textContent = lang.make;
            document.getElementById('txt-cust').textContent = lang.cust;
            document.getElementById('txt-best-promoter').textContent = lang.bestPromoter;
            document.getElementById('txt-banner-slogan').textContent = lang.bannerSlogan;
            document.getElementById('txt-event-title').textContent = lang.eventTitle;
            document.getElementById('txt-leaderboard-title').textContent = lang.leaderboardTitle;
            document.getElementById('txt-loading').textContent = lang.loading;
            document.getElementById('txt-tier-title').textContent = lang.tierTitle;
            document.getElementById('txt-feed-guide-title').textContent = lang.feedGuideTitle;
            document.getElementById('txt-start-weight-label').textContent = lang.startWeightLabel;
            document.getElementById('txt-ratio-label').textContent = lang.ratioLabel;
            document.getElementById('txt-ratio-value').textContent = lang.ratioValue;
            document.getElementById('txt-search-title').textContent = lang.searchTitle;
            document.getElementById('opt-all-brands').textContent = lang.allBrands;
            document.getElementById('txt-card-weight-label').textContent = lang.cardWeightLabel;
            document.getElementById('txt-card-feed-label').textContent = lang.cardFeedLabel;
            document.getElementById('txt-report-card-title').textContent = lang.reportCardTitle;
            document.getElementById('txt-unlocked-title').textContent = lang.unlockedTitle;
            document.getElementById('txt-btn-explain').textContent = lang.btnExplain;
            document.getElementById('txt-floor-rank-title').innerHTML = `<i data-lucide="shield-check" class="w-10 h-10 md:w-16 md:h-16 text-blue-600"></i> ${lang.floorRankTitle}`;
            document.getElementById('txt-dist-title').innerHTML = `<i data-lucide="pie-chart" class="w-10 h-10 text-orange-500"></i> ${lang.distTitle}`;

            document.getElementById('txt-modal-title').textContent = lang.modalTitle;
            document.getElementById('txt-modal-task1').textContent = lang.task1;
            document.getElementById('txt-modal-task2').textContent = lang.task2;
            document.getElementById('txt-modal-task3').textContent = lang.task3;
            document.getElementById('txt-modal-task4').textContent = lang.task4;
            document.getElementById('txt-modal-close').textContent = lang.modalClose;

            const tierList = document.getElementById('tier-list-container');
            const sortedMilestones = [...MILESTONES].reverse();
            tierList.innerHTML = sortedMilestones.map((m, idx) => {
                const isGold = m.min >= 800;
                return `<div class="${isGold ? 'relative bg-gradient-to-r from-yellow-100 via-yellow-50 to-white p-5 rounded-2xl border-[4px] border-yellow-500 shadow-2xl' : 'bg-white p-5 rounded-2xl border-2 border-gray-100 shadow-md'}">
                    <div class="flex items-start gap-4">
                        <div class="w-24 h-20 rounded-xl border border-gray-200 overflow-hidden shrink-0 bg-white shadow-inner"><img src="${m.img}" class="w-full h-full object-contain ${m.min < 500 ? 'grayscale' : ''}"></div>
                        <div class="flex-1"><div class="font-black text-gray-800 text-2xl leading-tight mb-1">${m.title[window.currentLang]}</div><div class="font-black ${isGold ? 'text-yellow-600' : 'text-gray-500'} text-xl mb-3">${m.min}kg${m.min >= 800 ? '+' : ''}</div>
                        <div class="bg-gray-50 rounded-xl p-3 border border-gray-200 shadow-inner"><div class="text-[10px] text-gray-400 font-bold uppercase mb-1">${lang.rewardLabel}</div><div class="text-[14px] font-black ${isGold ? 'text-yellow-800' : 'text-gray-800'} leading-snug">${m.reward[window.currentLang]}</div></div></div>
                    </div></div>`;
            }).join('');

            const tasksCont = document.getElementById('tasks-container');
            const taskData = [{ icon: "ğŸ‘€", title: lang.task1, reward: "x1" }, { icon: "ğŸª", title: lang.task2, reward: "x2" }, { icon: "ğŸ§§", title: lang.task3, reward: "x2" }, { icon: "ğŸ¤", title: lang.task4, reward: "x3" }];
            tasksCont.innerHTML = taskData.map((t, i) => `<div class="flex items-center gap-4 bg-orange-50/50 p-4 rounded-2xl border border-orange-100 shadow-sm"><div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center text-3xl shadow-sm border border-orange-50">${t.icon}</div><div class="flex-1"><div class="text-[10px] text-gray-400 font-bold uppercase tracking-tighter">${window.currentLang === 'zh' ? 'ä»»å‹™' : 'TASK'} ${i+1}</div><div class="text-lg font-black text-gray-800 leading-tight">${t.title}</div></div><div class="bg-orange-600 text-white px-4 py-2 rounded-full font-black text-lg shadow-md whitespace-nowrap">${t.reward} ${window.currentLang === 'zh' ? 'ä»½' : ''}</div></div>`).join('');

            populateFilterOptions();
            renderFloorRankings();
            renderFloorDistribution();
            lucide.createIcons();
            renderLeaderboard();
            populateUserSelect();
        }

        function switchRankBrand(brand) {
            window.currentRankBrand = brand;
            ['Dermes', 'Reenex', 'Elyze'].forEach(b => {
                const btn = document.getElementById(`tab-${b}`);
                if(btn) btn.className = `flex-1 py-4 px-2 rounded-[2rem] text-sm md:text-lg font-black transition-all ${b === brand ? `tab-active-${brand} shadow-md` : 'text-gray-500'}`;
            });
            renderFloorRankings();
            renderFloorDistribution();
        }

        function renderFloorRankings() {
            const container = document.getElementById('floor-ranking-content');
            if(!container) return;
            const lang = i18n[window.currentLang];
            const brand = window.currentRankBrand;
            const floorData = {};
            const brandPrefixMap = { 'Dermes': 'D', 'Reenex': 'R', 'Elyze': 'E' };
            const prefix = brandPrefixMap[brand];

            USERS.forEach(u => {
                const matchBrand = u.brand.toLowerCase().includes(brand.toLowerCase());
                const matchPrefix = u.location && u.location.toUpperCase().startsWith(prefix);
                if (matchBrand && matchPrefix) {
                    const loc = u.location;
                    if (!floorData[loc]) floorData[loc] = { totalWeight: 0, count: 0, t1: 0, t2: 0, t3: 0, t4: 0 };
                    floorData[loc].totalWeight += u.weight;
                    floorData[loc].t1 += u.task1; floorData[loc].t2 += u.task2; floorData[loc].t3 += u.task3; floorData[loc].t4 += u.task4;
                    floorData[loc].count += 1;
                }
            });

            const sortedFloors = Object.entries(floorData).map(([loc, data]) => {
                const avg = Math.round(data.totalWeight / data.count);
                const status = getCowStatus(avg);
                const next = getNextMilestone(avg);
                let progress = 100;
                if(next) progress = Math.min(100, Math.max(0, ((avg - status.min) / (next.min - status.min)) * 100));
                return { location: loc, avg: avg, status: status, progress: progress, t1: data.t1, t2: data.t2, t3: data.t3, t4: data.t4 };
            }).sort((a, b) => b.avg - a.avg);

            container.innerHTML = sortedFloors.length > 0 ? sortedFloors.map((f, idx) => `
                <div class="relative flex flex-col gap-4 p-8 rounded-[3rem] bg-white border border-gray-100 shadow-2xl overflow-hidden group">
                    <div class="strength-bar ${f.status.barColor}" style="width: ${f.progress}%"></div>
                    <div class="flex items-center gap-5 z-10 relative">
                        <div class="flex flex-col items-center justify-center min-w-[60px] shrink-0">
                            <span class="w-14 h-14 flex items-center justify-center font-black rounded-full text-2xl ${idx === 0 ? 'bg-yellow-400 text-white shadow-2xl border-4 border-white ring-2 ring-yellow-200' : idx === 1 ? 'bg-gray-300 text-white border-4 border-white' : idx === 2 ? 'bg-orange-300 text-white border-4 border-white' : 'bg-gray-100 text-gray-400'}">${idx + 1}</span>
                            <span class="font-black text-gray-900 text-lg mt-2 uppercase tracking-tighter leading-none">${f.location}</span>
                        </div>
                        <div class="w-24 h-20 rounded-[1.2rem] border-[3px] border-white overflow-hidden bg-white shrink-0 shadow-xl flex items-center justify-center group-hover:scale-110 transition-transform"><img src="${f.status.img}" class="w-full h-full object-contain" alt="Cow"></div>
                        <div class="flex-1 min-w-0">
                            <div class="text-[11px] font-black uppercase tracking-[0.2em] mb-1 ${f.status.color}">${f.status.title[window.currentLang]}</div>
                            <div class="text-6xl md:text-7xl font-black ${idx === 0 ? 'text-orange-600' : 'text-gray-800'} tracking-tighter leading-none flex items-baseline gap-1">${f.avg}<span class="text-sm font-black text-gray-400 uppercase tracking-normal">kg</span></div>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center justify-between gap-3 z-10 pt-5 mt-2 border-t border-gray-100/80">
                        <div class="flex-1 flex items-center justify-center gap-2 bg-white/70 py-2 rounded-2xl border border-gray-100 shadow-sm"><span class="text-xl">ğŸ‘€</span><span class="text-base font-black text-gray-700">${f.t1}</span></div>
                        <div class="flex-1 flex items-center justify-center gap-2 bg-white/70 py-2 rounded-2xl border border-gray-100 shadow-sm"><span class="text-xl">ğŸª</span><span class="text-base font-black text-gray-700">${f.t2}</span></div>
                        <div class="flex-1 flex items-center justify-center gap-2 bg-white/70 py-2 rounded-2xl border border-gray-100 shadow-sm"><span class="text-xl">ğŸ§§</span><span class="text-base font-black text-gray-700">${f.t3}</span></div>
                        <div class="flex-1 flex items-center justify-center gap-2 bg-white/70 py-2 rounded-2xl border border-gray-100 shadow-sm"><span class="text-xl">ğŸ¤</span><span class="text-base font-black text-gray-700">${f.t4}</span></div>
                    </div>
                </div>`).join('') : `<p class="text-gray-400 text-sm italic text-center py-24">ç›®å‰æ²’æœ‰ç¬¦åˆ ${brand} çš„æ¨“å±¤æ•¸æ“šã€‚</p>`;
        }

        // --- NEW: Floor Distribution Diagram Engine ---
        function renderFloorDistribution() {
            const container = document.getElementById('floor-distribution-content');
            if(!container) return;
            const brand = window.currentRankBrand;
            const brandPrefixMap = { 'Dermes': 'D', 'Reenex': 'R', 'Elyze': 'E' };
            const prefix = brandPrefixMap[brand];
            
            const floorLevelCounts = {};
            USERS.forEach(u => {
                const matchBrand = u.brand.toLowerCase().includes(brand.toLowerCase());
                const matchPrefix = u.location && u.location.toUpperCase().startsWith(prefix);
                if (matchBrand && matchPrefix) {
                    const loc = u.location;
                    if (!floorLevelCounts[loc]) floorLevelCounts[loc] = [0,0,0,0,0]; // one index for each MILESTONE
                    const status = getCowStatus(u.weight);
                    const milestoneIdx = MILESTONES.findIndex(m => m.min === status.min);
                    if(milestoneIdx !== -1) floorLevelCounts[loc][milestoneIdx]++;
                }
            });

            const barColors = ['bg-gray-400', 'bg-green-500', 'bg-blue-500', 'bg-purple-500', 'bg-yellow-500'];
            
            container.innerHTML = Object.entries(floorLevelCounts).length > 0 ? Object.entries(floorLevelCounts).map(([loc, counts]) => {
                const total = counts.reduce((a,b) => a+b, 0);
                return `
                    <div class="bg-white p-5 rounded-[2rem] shadow-lg border border-gray-50 transition-all hover:shadow-xl">
                        <div class="flex justify-between items-end mb-3">
                            <h5 class="font-black text-gray-800 text-lg uppercase tracking-tighter">${loc}</h5>
                            <span class="text-[10px] font-bold text-gray-400">Total: ${total} Therapists</span>
                        </div>
                        <div class="w-full h-8 flex rounded-full overflow-hidden shadow-inner bg-gray-100">
                            ${counts.map((count, idx) => {
                                if(count === 0) return '';
                                const pct = (count / total) * 100;
                                return `<div class="${barColors[idx]} h-full border-r border-white/20 last:border-0 flex items-center justify-center transition-all duration-1000" style="width: ${pct}%">
                                    <span class="text-[10px] font-black text-white drop-shadow-sm">${count}</span>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('') : `<p class="text-gray-400 text-sm italic text-center py-10">No distribution data for ${brand}</p>`;
        }

        function populateFilterOptions() {
            const bS = document.getElementById('brand-filter'), lS = document.getElementById('location-filter');
            if(!lS || !bS) return;
            const b = bS.value, bPM = { 'Dermes': 'D', 'Reenex': 'R', 'Elyze': 'E' }, p = bPM[b], cV = lS.value;
            let locs = [...new Set(USERS.map(u => u.location))].filter(l => l).sort();
            if (p) locs = locs.filter(loc => loc.toUpperCase().startsWith(p));
            lS.innerHTML = `<option value="">${i18n[window.currentLang].allLocations}</option>`;
            locs.forEach(loc => { const opt = document.createElement('option'); opt.value = loc; opt.textContent = loc; lS.appendChild(opt); });
            if (locs.includes(cV)) lS.value = cV; else lS.value = "";
        }

        function populateUserSelect() {
            const bS = document.getElementById('brand-filter'), lS = document.getElementById('location-filter'), uS = document.getElementById('user-select'), uC = document.getElementById('user-card');
            if(!bS || !lS || !uS) return;
            const b = bS.value, l = lS.value, bPM = { 'Dermes': 'D', 'Reenex': 'R', 'Elyze': 'E' }, p = bPM[b];
            uS.innerHTML = '';
            const filtered = USERS.filter(u => {
                const bM = !b || u.brand.toLowerCase() === b.toLowerCase();
                const pM = !b || (u.location && u.location.toUpperCase().startsWith(p));
                const lM = !l || u.location === l;
                return bM && pM && lM;
            });
            if (filtered.length === 0) { uS.innerHTML = `<option disabled selected>${i18n[window.currentLang].noMatch}</option>`; if(uC) uC.classList.add('hidden'); return; }
            filtered.forEach(u => { const o = document.createElement('option'); o.value = u.id; o.textContent = `${u.name} (${u.brand}-${u.location})`; uS.appendChild(o); });
            updateUserCard(filtered[0].id);
        }

        function updateUserCard(userId) {
            const user = USERS.find(u => u.id == userId);
            if (!user || !document.getElementById('user-card')) return;
            const rank = USERS.findIndex(u => u.id == userId) + 1, status = getCowStatus(user.weight), next = getNextMilestone(user.weight), lang = i18n[window.currentLang];
            document.getElementById('card-name').textContent = user.name;
            document.getElementById('card-rank').textContent = `# ${rank}`;
            document.getElementById('card-weight').textContent = `${user.weight}kg`;
            document.getElementById('card-feeds').textContent = `${user.feeds}${window.currentLang === 'zh' ? 'ä»½' : ''}`;
            document.getElementById('card-level-title').textContent = status.title[window.currentLang];
            document.getElementById('card-reward-name').textContent = status.value ? `${status.reward[window.currentLang]} (${lang.valueLabel}: ${status.value})` : status.reward[window.currentLang];
            document.getElementById('card-brand').textContent = user.brand;
            document.getElementById('card-brand').className = `brand-badge brand-${user.brand} text-[10px]`;
            document.getElementById('card-location').textContent = user.location;
            const cardTasksGrid = document.getElementById('card-tasks-grid');
            cardTasksGrid.innerHTML = [{ label: lang.tLabel1, count: user.task1 }, { label: lang.tLabel2, count: user.task2 }, { label: lang.tLabel3, count: user.task3 }, { label: lang.tLabel4, count: user.task4 }].map(t => `<div class="bg-white p-2 rounded border border-[#D7CCC8] flex justify-between items-center shadow-sm"><span class="text-[#5D4037] font-black">${t.label}</span><span class="font-black text-white bg-[#8D6E63] px-2 py-0.5 rounded-full">${t.count}</span></div>`).join('');
            document.getElementById('card-cow-img').src = status.img;
            const nextEl = document.getElementById('card-next-level'), prgEl = document.getElementById('card-progress-bar'), diffEl = document.getElementById('card-diff-text');
            if (next) {
                nextEl.textContent = `${lang.goal}: ${next.title[window.currentLang]}`;
                const prg = Math.min(100, Math.max(0, ((user.weight - status.min) / (next.min - status.min)) * 100));
                if(prgEl) prgEl.style.width = `${prg}%`;
                const feedsLeft = Math.round((next.min - user.weight) / 5);
                if(diffEl) diffEl.innerHTML = lang.feedsToUpgrade.replace('{n}', `<span class="font-black text-red-600">${feedsLeft}</span>`);
            } else { nextEl.textContent = lang.maxLevel; prgEl.style.width = "100%"; diffEl.textContent = lang.congrats; }
            document.getElementById('user-card').classList.remove('hidden');
        }

        async function fetchLeaderboardData() {
            const loading = document.getElementById('loading-indicator');
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const data = await response.json();
                USERS = data.map(item => {
                    const bRaw = getProp(item, ["brand", "Brand", "BRAND"]);
                    let brand = "Unknown";
                    if (bRaw.toLowerCase().includes("dermes")) brand = "Dermes";
                    else if (bRaw.toLowerCase().includes("reenex")) brand = "Reenex";
                    else if (bRaw.toLowerCase().includes("elyze")) brand = "Elyze";
                    const loc = getProp(item, ["location", "Location", "LOCATION"]);
                    const name = getProp(item, ["name", "Name", "NAME", "Staff Name"]);
                    const id = parseInt(getProp(item, ["id", "ID"])) || 0;
                    const stats = calculateStats(parseInt(getProp(item, ["task1", "Task1"]))||0, parseInt(getProp(item, ["task2", "Task2"]))||0, parseInt(getProp(item, ["task3", "Task3"]))||0, parseInt(getProp(item, ["task4", "Task4"]))||0);
                    return { id, name, brand, location: loc, task1: parseInt(getProp(item, ["task1", "Task1"]))||0, task2: parseInt(getProp(item, ["task2", "Task2"]))||0, task3: parseInt(getProp(item, ["task3", "Task3"]))||0, task4: parseInt(getProp(item, ["task4", "Task4"]))||0, feeds: stats.totalFeeds, weight: stats.weight };
                }).filter(u => u.name).sort((a, b) => b.weight - a.weight);
                updateUI(); 
            } catch (error) {
                console.error("Fetch error:", error);
                if(loading) loading.innerHTML = `<p class="text-red-500 font-black px-6 text-xl">æ•¸æ“šè®€å–å¤±æ•—ã€‚</p>`;
            } finally { if (loading) loading.classList.add('hidden'); }
        }

        function renderLeaderboard() {
            const grid = document.getElementById('leaderboard-grid');
            if(!grid) return;
            grid.innerHTML = ''; 
            USERS.slice(0, 10).forEach((user, index) => {
                const status = getCowStatus(user.weight);
                const rank = index + 1;
                let rs = rank === 1 ? "bg-yellow-400 text-white w-14 h-14 text-3xl border-4 border-white shadow-xl ring-2 ring-yellow-200" : rank <= 3 ? "bg-gray-300 text-white w-10 h-10 text-xl border-4 border-white shadow-lg" : "bg-white text-gray-600 w-8 h-8 text-lg border border-gray-200 shadow-md";
                const card = document.createElement('div');
                card.className = "relative flex flex-col items-center group";
                card.innerHTML = `<div class="cow-image-container mb-2 transition-all duration-300 relative shadow-2xl"><img src="${status.img}" alt="${status.title[window.currentLang]}" onerror="this.src='https://placehold.co/640x480?text=Loading';"><div class="absolute top-2 left-2 rounded-full flex items-center justify-center font-black rank-badge ${rs}">${rank === 1 ? 'ğŸ‘‘' : ''}${rank}</div><div class="absolute bottom-2 right-2 bg-white/95 px-3 py-1 rounded text-sm font-black text-red-600 shadow-md ring-1 ring-red-100">${user.weight}kg</div></div><div class="bg-white/95 backdrop-blur-sm rounded-xl p-4 shadow-xl border-2 ${rank <= 3 ? 'border-yellow-200' : 'border-white'} text-center w-full relative z-30"><div class="text-xl font-black text-gray-800 truncate px-1 tracking-tighter leading-tight">${user.name}</div><div class="flex justify-center gap-1 mt-2 mb-2"><span class="brand-badge brand-${user.brand} scale-100">${user.brand}</span><span class="bg-gray-100 text-gray-500 text-[11px] px-2 rounded-full font-black flex items-center">${user.location}</span></div><div class="bg-gray-100 rounded-lg px-2 py-3 border border-gray-200/50 shadow-inner"><div class="text-base sm:text-xl font-black tracking-tighter leading-tight ${status.color}">${status.title[window.currentLang]}</div></div></div>`;
                grid.appendChild(card);
            });
        }

        function changeLanguage(lang) {
            window.currentLang = lang;
            document.getElementById('btn-zh').className = `px-4 py-1.5 rounded-full text-sm font-black transition-all ${lang === 'zh' ? 'bg-red-600 text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'}`;
            document.getElementById('btn-en').className = `px-4 py-1.5 rounded-full text-sm font-black transition-all ${lang === 'en' ? 'bg-red-600 text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'}`;
            updateUI();
        }

        const bFlt = document.getElementById('brand-filter'), lFlt = document.getElementById('location-filter'), uSlt = document.getElementById('user-select');
        if(bFlt) bFlt.addEventListener('change', () => { populateFilterOptions(); populateUserSelect(); });
        if(lFlt) lFlt.addEventListener('change', populateUserSelect);
        if(uSlt) uSlt.addEventListener('change', (e) => updateUserCard(e.target.value));

        fetchLeaderboardData();
    </script>
</body>
</html>
