<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neoderm 200% 銷售計劃</title>
    <!-- Tailwind CSS for Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        :root {
            --bg-color: #050505;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color); 
            color: white;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        /* Hide number input spinners */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='rgba(255,255,255,0.4)'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }

        .animate-shimmer {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;
        
        // Manual Lucide Icon Mapping for CDN usage
        const Icon = ({ name, className, size = 24 }) => {
            const [svg, setSvg] = useState('');
            useEffect(() => {
                if (window.lucide) {
                    const iconNode = window.lucide.icons[name];
                    if (iconNode) {
                        const svgString = iconNode.map(tag => {
                            const [tagName, attrs] = tag;
                            const attrString = Object.entries(attrs).map(([k, v]) => `${k}="${v}"`).join(' ');
                            return `<${tagName} ${attrString}></${tagName}>`;
                        }).join('');
                        setSvg(svgString);
                    }
                }
            }, [name]);

            return (
                <svg 
                    width={size} 
                    height={size} 
                    className={className} 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round"
                    dangerouslySetInnerHTML={{ __html: svg }}
                />
            );
        };

        const formatHKD = (val) => new Intl.NumberFormat('zh-HK', { style: 'currency', currency: 'HKD', maximumFractionDigits: 0 }).format(val);

        // 將 SignInput 移至外部防止重新掛載導致失去焦點
        const SignInput = ({ id, label, colorClass, iconName, planning, onUpdate }) => {
            const item = planning[id];
            const subtotal = Number(item.signs || 0) * Number(item.ticket || 0);

            return (
                <div className="relative group p-4 md:p-5 glass-panel rounded-3xl transition-all duration-300">
                    <div className="flex items-center gap-3 mb-4">
                        <div className={`p-2 rounded-xl bg-gradient-to-br ${colorClass} bg-opacity-10`}>
                            <Icon name={iconName} size={18} className="text-white" />
                        </div>
                        <span className="text-sm font-bold text-white/90 tracking-wide">{label}</span>
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                        <div className="space-y-1">
                            <label className="text-[9px] text-white/40 font-bold uppercase ml-1">簽單數量</label>
                            <input 
                                type="number" 
                                inputMode="numeric"
                                value={item.signs}
                                onChange={(e) => onUpdate(id, 'signs', e.target.value)}
                                className="w-full bg-black/40 border border-white/5 rounded-xl px-3 py-3 text-lg text-white font-mono focus:ring-1 focus:ring-white/20 outline-none transition-all"
                                placeholder="0"
                            />
                        </div>
                        <div className="space-y-1">
                            <label className="text-[9px] text-white/40 font-bold uppercase ml-1">平均客單價</label>
                            <input 
                                type="number" 
                                inputMode="numeric"
                                value={item.ticket}
                                onChange={(e) => onUpdate(id, 'ticket', e.target.value)}
                                className="w-full bg-black/40 border border-white/5 rounded-xl px-3 py-3 text-lg text-white font-mono focus:ring-1 focus:ring-white/20 outline-none transition-all"
                                placeholder="0"
                            />
                        </div>
                    </div>
                    <div className="mt-4 flex justify-between items-center px-1">
                        <span className="text-[10px] text-white/30 font-medium">小計</span>
                        <span className="text-xs md:text-sm font-black text-white/80">{formatHKD(subtotal)}</span>
                    </div>
                </div>
            );
        };

        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwP0O0BsCWK0MN03uayShGS8-WWHBgPRZWz9LCTEiF4amChe2PoBVQYKOm_v_cmKqF7XQ/exec";

        const App = () => {
            const [db, setDb] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            const [filters, setFilters] = useState({ brand: "", center: "", therapist: "" });
            const [planning, setPlanning] = useState({
                upsell: { signs: 0, ticket: 6000 },
                birthday: { signs: 0, ticket: 4500 },
                tail: { signs: 0, ticket: 8000 },
                icb: { signs: 0, ticket: 12000 },
            });

            useEffect(() => {
                fetchData();
            }, []);

            const fetchData = async () => {
                setIsLoading(true);
                setError(null);
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache',
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (Array.isArray(data)) {
                        setDb(data);
                    } else {
                        throw new Error("數據格式錯誤：預期應為陣列格式。");
                    }
                } catch (err) {
                    console.error("Fetch Error:", err);
                    setError("數據連接失敗。請檢查：\n1. App Script 是否已發布為「所有人」(Anyone)\n2. 網路連線是否正常");
                } finally {
                    setIsLoading(false);
                }
            };

            const handleUpdate = useCallback((id, field, value) => {
                setPlanning(prev => ({
                    ...prev,
                    [id]: {
                        ...prev[id],
                        [field]: value
                    }
                }));
            }, []);

            const brands = useMemo(() => [...new Set(db.map(i => i.Brand))].filter(Boolean).sort(), [db]);
            const centers = useMemo(() => [...new Set(db.filter(i => !filters.brand || i.Brand === filters.brand).map(i => i.Center))].filter(Boolean).sort(), [db, filters.brand]);
            const therapists = useMemo(() => db.filter(i => (!filters.brand || i.Brand === filters.brand) && (!filters.center || i.Center === filters.center)).sort((a,b) => a.Therapist.localeCompare(b.Therapist)), [db, filters.brand, filters.center]);
            const selectedStaff = useMemo(() => db.find(i => i.Therapist === filters.therapist), [db, filters.therapist]);

            const calcSales = (key) => Number(planning[key].signs || 0) * Number(planning[key].ticket || 0);
            const existingSales = calcSales('upsell') + calcSales('birthday');
            const newSales = calcSales('tail') + calcSales('icb');
            const totalPlannedGrowth = existingSales + newSales;
            const mtdActual = selectedStaff ? Number(selectedStaff["Actual Sales (MTD)"] || 0) : 0;
            const projectedMonthEnd = mtdActual + totalPlannedGrowth;
            const originalTarget = selectedStaff ? Number(selectedStaff["Target Sales (Full Month)"] || 0) : 0;
            const superTarget = originalTarget * 2;
            const isTargetAchieved = selectedStaff && superTarget > 0 && projectedMonthEnd >= superTarget;
            const displayMtdPct = selectedStaff ? (Number(selectedStaff["MTD%"] || 0) * 100).toFixed(1) : "0";

            return (
                <div className="min-h-screen relative">
                    {/* Background Decor */}
                    <div className="fixed inset-0 pointer-events-none -z-10">
                        <div className="absolute top-[-5%] left-[-5%] w-[60%] h-[40%] bg-cyan-600/10 blur-[100px] rounded-full"></div>
                        <div className="absolute bottom-[-5%] right-[-5%] w-[60%] h-[40%] bg-blue-600/10 blur-[100px] rounded-full"></div>
                    </div>

                    {/* Loading/Error State Overlay */}
                    {isLoading && (
                        <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex flex-col items-center justify-center">
                            <Icon name="RefreshCw" className="w-10 h-10 text-cyan-500 animate-spin mb-4" size={40} />
                            <p className="text-cyan-500 font-bold tracking-widest animate-pulse">數據加載中...</p>
                        </div>
                    )}

                    <div className="relative z-10 max-w-7xl mx-auto px-4 py-6 md:px-10 md:py-12">
                        <header className="flex flex-col gap-8 mb-10 md:mb-16">
                            <div className="text-center md:text-left">
                                <div className="flex items-center gap-3 mb-2 justify-center md:justify-start">
                                    <div className="h-1 w-8 bg-cyan-500 rounded-full"></div>
                                    <span className="text-[9px] font-black text-cyan-500 uppercase tracking-[0.4em]">v2.5 Stable Link</span>
                                </div>
                                <h1 className="text-3xl md:text-5xl lg:text-6xl font-black tracking-tighter italic leading-tight">
                                    Neoderm <span className="text-transparent bg-clip-text bg-gradient-to-r from-white via-white/80 to-white/40">200% 銷售計劃</span>
                                </h1>
                            </div>

                            <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 p-2 glass-panel rounded-2xl md:rounded-[2.5rem]">
                                {['brand', 'center', 'therapist'].map((key) => (
                                    <div key={key} className="relative w-full">
                                        <select 
                                            value={filters[key]}
                                            onChange={(e) => {
                                                const val = e.target.value;
                                                if (key === 'brand') setFilters({ brand: val, center: "", therapist: "" });
                                                else if (key === 'center') setFilters({ ...filters, center: val, therapist: "" });
                                                else setFilters({ ...filters, [key]: val });
                                            }}
                                            className="w-full bg-black/60 border border-white/5 rounded-xl md:rounded-[2rem] px-5 py-3.5 text-sm font-bold text-white outline-none cursor-pointer hover:bg-black/80 transition-colors"
                                        >
                                            <option value="">選擇{key === 'brand' ? '品牌' : key === 'center' ? '中心' : '治療師'}</option>
                                            {(key === 'brand' ? brands : key === 'center' ? centers : therapists.map(t => t.Therapist)).map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                        </select>
                                    </div>
                                ))}
                            </div>
                            
                            {error && (
                                <div className="p-4 bg-red-500/10 border border-red-500/20 rounded-2xl flex items-start gap-3 text-red-400 text-sm animate-in slide-in-from-top-2">
                                    <Icon name="AlertCircle" size={20} className="w-5 h-5 flex-shrink-0 mt-0.5" />
                                    <pre className="whitespace-pre-wrap font-sans">{error}</pre>
                                </div>
                            )}
                        </header>

                        {selectedStaff ? (
                            <div className="animate-in fade-in duration-700">
                                <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6 mb-10 md:mb-16">
                                    {[
                                        { label: 'MTD 實際銷售', value: formatHKD(mtdActual), icon: 'DollarSign', color: 'text-white' },
                                        { label: '當前達成率', value: `${displayMtdPct}%`, icon: 'ShieldCheck', color: 'text-emerald-400' },
                                        { label: 'ACB 數量', value: selectedStaff["ACB (Curr. Month End)"], icon: 'Users', color: 'text-cyan-400' },
                                        { label: 'ICB 數量', value: selectedStaff["ICB (Curr. Month End)"], icon: 'Zap', color: 'text-blue-400' }
                                    ].map((m, i) => (
                                        <div key={i} className="p-4 md:p-6 glass-panel rounded-2xl md:rounded-[2rem] relative overflow-hidden group">
                                            <div className="absolute inset-0 bg-white/[0.02] opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                            <div className="flex items-center gap-2 mb-1">
                                                <Icon name={m.icon} size={14} className="text-white/20" />
                                                <span className="text-[9px] md:text-[10px] text-white/40 font-bold uppercase tracking-wider">{m.label}</span>
                                            </div>
                                            <div className={`text-lg md:text-2xl font-black ${m.color}`}>{m.value}</div>
                                        </div>
                                    ))}
                                </div>

                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 md:gap-12 mb-12 md:mb-16">
                                    <section className="space-y-6">
                                        <div className="flex items-center gap-3 px-2">
                                            <div className="h-4 w-1 bg-cyan-500 rounded-full"></div>
                                            <h2 className="text-2xl font-black italic tracking-tight">舊客 PILLAR</h2>
                                        </div>
                                        <SignInput id="upsell" label="追加簽單 (UP-SELL)" colorClass="from-cyan-500" iconName="TrendingUp" planning={planning} onUpdate={handleUpdate} />
                                        <SignInput id="birthday" label="生日簽單 (BIRTHDAY)" colorClass="from-cyan-400" iconName="Zap" planning={planning} onUpdate={handleUpdate} />
                                        <div className="px-4 py-2 text-right">
                                            <span className="text-[10px] text-white/30 font-bold uppercase mr-3">PILLAR 增長</span>
                                            <span className="text-xl font-black text-cyan-400 font-mono">{formatHKD(existingSales)}</span>
                                        </div>
                                    </section>
                                    
                                    <section className="space-y-6">
                                        <div className="flex items-center gap-3 px-2">
                                            <div className="h-4 w-1 bg-blue-500 rounded-full"></div>
                                            <h2 className="text-2xl font-black italic tracking-tight">新客 PILLAR</h2>
                                        </div>
                                        <SignInput id="tail" label="一龍尾 (TAIL)" colorClass="from-blue-500" iconName="Activity" planning={planning} onUpdate={handleUpdate} />
                                        <SignInput id="icb" label="ICB 簽單 (ICB SIGN)" colorClass="from-blue-400" iconName="Zap" planning={planning} onUpdate={handleUpdate} />
                                        <div className="px-4 py-2 text-right">
                                            <span className="text-[10px] text-white/30 font-bold uppercase mr-3">PILLAR 增長</span>
                                            <span className="text-xl font-black text-blue-400 font-mono">{formatHKD(newSales)}</span>
                                        </div>
                                    </section>
                                </div>

                                <div className="relative group rounded-[2.5rem] md:rounded-[3.5rem] overflow-hidden mb-12">
                                    <div className="absolute inset-0 bg-gradient-to-br from-white/[0.05] to-transparent pointer-events-none"></div>
                                    <div className="glass-panel p-6 md:p-12 relative">
                                        <div className="absolute top-0 right-6 md:right-12 bg-gradient-to-r from-orange-500 to-red-600 px-4 py-1.5 rounded-b-xl flex items-center gap-2 shadow-xl">
                                            <Icon name="Flame" size={12} className="text-white" />
                                            <span className="text-[9px] font-black uppercase tracking-tighter">200% Super Target</span>
                                        </div>

                                        <div className="flex flex-col lg:flex-row items-center gap-10">
                                            <div className="flex-1 w-full text-center lg:text-left">
                                                <span className="text-[10px] text-white/30 font-black uppercase tracking-[0.4em] block mb-4">預估規劃總增長額</span>
                                                <div className="text-5xl sm:text-7xl md:text-8xl lg:text-9xl font-black text-white leading-tight mb-8 tracking-tighter">
                                                    {formatHKD(totalPlannedGrowth)}
                                                </div>
                                                
                                                <div className="flex flex-col sm:flex-row gap-3 justify-center lg:justify-start">
                                                    <div className="px-5 py-3 bg-white/5 rounded-2xl border border-white/5 flex-1 max-w-[240px]">
                                                        <span className="text-[9px] text-white/40 block mb-1 font-bold">月尾預計總額</span>
                                                        <span className="text-lg font-black text-white">{formatHKD(projectedMonthEnd)}</span>
                                                    </div>
                                                    <div className="px-5 py-3 bg-orange-500/10 rounded-2xl border border-orange-500/10 flex-1 max-w-[240px]">
                                                        <span className="text-[9px] text-orange-400 block mb-1 font-bold">200% 目標額</span>
                                                        <span className="text-lg font-black text-orange-400">{formatHKD(superTarget)}</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="flex flex-col gap-6 items-center lg:items-end w-full lg:w-auto min-w-[280px]">
                                                <div className="text-center lg:text-right">
                                                    <div className="text-5xl md:text-7xl font-black text-white mb-2 tabular-nums tracking-tighter">
                                                        {superTarget > 0 ? ((projectedMonthEnd / superTarget) * 100).toFixed(1) : 0}%
                                                    </div>
                                                    <div className="text-[10px] text-white/30 font-black uppercase tracking-widest">模擬達成率 (對標 200%)</div>
                                                </div>

                                                <div className={`w-full py-4 px-6 rounded-2xl text-center text-sm font-black tracking-widest uppercase border transition-all duration-500 shadow-lg ${isTargetAchieved ? 'bg-emerald-500 text-black border-emerald-400' : 'bg-white/5 text-white/40 border-white/10'}`}>
                                                    {isTargetAchieved ? (
                                                        <div className="flex items-center justify-center gap-2">
                                                            <Icon name="ShieldCheck" size={16} /> 200% 目標已鎖定
                                                        </div>
                                                    ) : (
                                                        `尚欠 ${formatHKD(Math.max(0, superTarget - projectedMonthEnd))}`
                                                    )}
                                                </div>
                                            </div>
                                        </div>

                                        <div className="mt-12 h-3 w-full bg-white/5 rounded-full overflow-hidden p-0.5 border border-white/5">
                                            <div 
                                                className="h-full bg-gradient-to-r from-cyan-500 via-blue-500 to-indigo-600 rounded-full transition-all duration-1000 ease-out relative" 
                                                style={{ width: `${selectedStaff && superTarget > 0 ? Math.min(100, (projectedMonthEnd / superTarget) * 100) : 0}%` }}
                                            >
                                                <div className="absolute top-0 right-0 h-full w-4 bg-white/20 blur-sm"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="glass-panel p-12 rounded-[2.5rem] text-center space-y-4 animate-pulse">
                                <Icon name="Users" size={48} className="mx-auto text-white/10" />
                                <p className="text-white/40 font-bold uppercase tracking-widest">請先在上方選擇治療師以開始規劃</p>
                            </div>
                        )}
                        
                        <footer className="text-center pb-8 opacity-20 mt-12">
                            <span className="text-[9px] font-black uppercase tracking-[0.5em]">Neo Derm Strategy Center &copy; 2024</span>
                        </footer>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>