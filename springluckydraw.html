<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜¥æ—¥ç¾è‚Œç¶»æ”¾å¤§æŠ½ç - NeoDerm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --neo-rose: #ff4d6d;
            --neo-rose-dark: #c9184a;
            --neo-sky: #0ea5e9;
            --neo-sky-dark: #0369a1;
            --gold: #fbbf24;
            --glass-white: rgba(255, 255, 255, 0.9);
        }

        body {
            font-family: 'Poppins', 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #fff1f2 100%);
            color: #1e293b;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* Sakura Petals Effect */
        #sakura-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1;
        }

        .petal {
            position: absolute;
            background: linear-gradient(135deg, #ffdbed 0%, #ffb7d5 100%);
            border-radius: 150% 0 150% 50%;
            opacity: 0.6;
            animation: fall linear infinite;
        }

        @keyframes fall {
            0% { transform: translate(0, -20px) rotate(0deg) scale(1); }
            100% { transform: translate(100px, 110vh) rotate(720deg) scale(0.6); }
        }

        /* Impactful Banner Container */
        .banner-wrapper {
            width: 100%;
            position: relative;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .banner-img {
            width: 100%;
            max-width: 1200px; /* Limits width on desktop to prevent excessive height */
            height: auto;
            display: block;
        }

        /* Floating Prize Badge */
        .prize-badge {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(3, 105, 161, 0.95);
            backdrop-filter: blur(10px);
            padding: 10px 25px;
            border-radius: 50px;
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 30px rgba(3, 105, 161, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 20;
            white-space: nowrap;
        }

        .prize-badge-icon {
            background: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .prize-badge-content { color: white; }
        .prize-badge-title { font-size: 1.1rem; font-weight: 800; }
        .prize-badge-val { color: var(--gold); font-weight: 900; }

        @media (max-width: 640px) {
            .prize-badge { padding: 6px 16px; bottom: 10px; gap: 8px; }
            .prize-badge-icon { width: 30px; height: 30px; font-size: 1rem; }
            .prize-badge-title { font-size: 0.8rem; }
        }

        /* UI Cards */
        .glass-card {
            background: var(--glass-white);
            backdrop-filter: blur(20px);
            border: 1px solid white;
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.04);
            position: relative;
            z-index: 10;
        }

        .neo-gradient-text {
            background: linear-gradient(135deg, #1e293b 0%, #c9184a 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900;
        }

        .pool-tab {
            transition: all 0.3s ease;
            border: 2px solid transparent;
            opacity: 0.75;
        }

        .pool-tab.active {
            opacity: 1;
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.08);
            border-color: white;
        }

        /* Gacha Styles */
        .gacha-container { position: relative; width: 280px; height: 400px; margin: 0 auto; }
        .gacha-glass {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 260px; height: 260px;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.85) 0%, rgba(186, 230, 253, 0.4) 100%);
            border: 6px solid #fff; border-radius: 50%; backdrop-filter: blur(2px); overflow: hidden;
            box-shadow: inset 0 10px 30px rgba(255,255,255,1), 0 15px 35px rgba(0,0,0,0.05);
            z-index: 5;
        }

        .gacha-base {
            position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 220px; height: 160px; background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%);
            border-radius: 20px 20px 40px 40px; z-index: 4; border: 3px solid #fff;
            box-shadow: 0 10px 25px rgba(3, 105, 161, 0.2);
        }

        .gacha-knob { 
            width: 55px; height: 55px; background: #fbbf24; border-radius: 50%; border: 3px solid #fff;
            cursor: pointer; transition: 0.4s; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
        }

        .shaking { animation: shake 0.1s infinite; }
        @keyframes shake { 0%, 100% { transform: translate(-50%, 0); } 25% { transform: translate(-50.5%, 1px); } 75% { transform: translate(-49.5%, -1px); } }

        .btn-impact {
            background: linear-gradient(135deg, #0369a1 0%, #0ea5e9 100%);
            color: white;
            padding: 16px 40px;
            border-radius: 100px;
            font-weight: 800;
            font-size: 1.1rem;
            transition: 0.3s;
            box-shadow: 0 8px 20px rgba(14, 165, 233, 0.3);
        }

        .hidden-step { display: none; }
        
        .quota-table { width: 100%; border-collapse: separate; border-spacing: 0 4px; }
        .quota-table td { padding: 10px; background: #fff; border-radius: 4px; }

        .status-msg { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; }
    </style>
</head>
<body class="antialiased">
    <div id="sakura-container"></div>

    <!-- Banner Section -->
    <section class="banner-wrapper">
        <div class="prize-badge">
            <div class="prize-badge-icon">ğŸ’</div>
            <div class="prize-badge-content">
                <p class="prize-badge-title">Ultherapy ç™‚ç¨‹ <span class="prize-badge-val">$32,888</span></p>
            </div>
        </div>
        <img src="https://image2url.com/r2/default/images/1772197034322-b5062db0-1c7c-4337-a113-a1e0f9b526ff.jpeg" class="banner-img" alt="NeoDerm Spring Beauty">
    </section>

    <div class="max-w-4xl mx-auto px-4 py-8 relative z-10">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl neo-gradient-text mb-4">æ˜¥æ—¥ç¾è‚Œç¶»æ”¾å¤§æŠ½ç</h1>
            <p class="text-sky-800 font-bold bg-sky-100/60 inline-block px-4 py-1 rounded-full text-xs">å³æ—¥è‡³ 2026å¹´3æœˆ31æ—¥</p>
        </header>

        <!-- STEP 1: POOL SELECTION -->
        <div id="step-eligibility" class="glass-card p-6 md:p-10 mb-8">
            <div class="text-center mb-8">
                <h2 class="text-lg font-extrabold text-slate-800">è«‹é¸æ“‡æ‚¨çš„æ¶ˆè²»å½©æ± </h2>
                <p class="text-slate-400 text-xs">æ ¹æ“šæ‚¨çš„ç™¼ç¥¨ç¸½é¡é¸æ“‡å°æ‡‰çµ„åˆ¥</p>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                <button onclick="selectPool('gold')" id="tab-gold" class="pool-tab tab-gold p-5 rounded-2xl flex flex-col items-center gap-2">
                    <span class="text-2xl">âœ¨</span>
                    <span class="font-black text-sm">æ˜¥æ—¥é‡‘æ± </span>
                    <span class="text-[9px] font-bold py-1 px-3 bg-white/50 rounded-full">>= $50,000</span>
                </button>
                <button onclick="selectPool('silver')" id="tab-silver" class="pool-tab tab-silver p-5 rounded-2xl flex flex-col items-center gap-2">
                    <span class="text-2xl">ğŸ¥ˆ</span>
                    <span class="font-black text-sm">æ˜¥æ—¥éŠ€æ± </span>
                    <span class="text-[9px] font-bold py-1 px-3 bg-white/50 rounded-full">$30K - $49K</span>
                </button>
                <button onclick="selectPool('bronze')" id="tab-bronze" class="pool-tab tab-bronze p-5 rounded-2xl flex flex-col items-center gap-2">
                    <span class="text-2xl">ğŸ¥‰</span>
                    <span class="font-black text-sm">æ˜¥æ—¥éŠ…æ± </span>
                    <span class="text-[9px] font-bold py-1 px-3 bg-white/50 rounded-full">$15K - $29K</span>
                </button>
            </div>

            <div class="flex justify-center mb-10">
                <button onclick="selectPool('birthday')" id="tab-birthday" class="pool-tab tab-birthday w-full max-w-md p-5 rounded-2xl flex items-center justify-center gap-4">
                    <span class="text-3xl">ğŸ‚</span>
                    <div class="text-left">
                        <span class="font-black text-sm block">ç”Ÿæ—¥å½©æ±  ç‰¹åˆ¥çå‹µ</span>
                        <span class="text-[9px] font-bold opacity-70 uppercase tracking-widest">2 / 3 / 4 æœˆç”Ÿæ—¥å°ˆäº«</span>
                    </div>
                </button>
            </div>

            <div class="bg-white/50 border border-white/50 p-4 rounded-xl mb-8 text-center min-h-[60px] flex items-center justify-center">
                <p id="pool-description" class="text-slate-600 text-xs font-medium italic">è¼‰å…¥ä¸­...</p>
            </div>

            <button onclick="confirmEntry()" class="w-full btn-impact uppercase tracking-widest">é€²å…¥æŠ½ç</button>
            
            <button onclick="toggleQuotaDashboard()" class="w-full mt-10 text-slate-400 text-[10px] font-bold tracking-widest hover:text-sky-500 transition-colors uppercase">
                ğŸ“Š å…§éƒ¨é…é¡å¯¦æ™‚æ¦‚æ³
            </button>
            
            <div id="quota-dashboard" class="hidden mt-6 bg-slate-100 rounded-2xl p-6 border border-slate-200 shadow-inner">
                <div id="quota-auth-section" class="text-center">
                    <p class="status-msg text-slate-400">ç®¡ç†æ¬Šé™é©—è­‰</p>
                    <div class="flex gap-2 max-w-xs mx-auto">
                        <input type="password" id="quota-password-input" placeholder="å¯†ç¢¼" class="flex-1 px-4 py-2 rounded-xl text-sm border-slate-200 outline-none">
                        <button onclick="verifyQuotaPassword()" class="bg-slate-800 text-white px-5 py-2 rounded-xl text-xs font-bold">ç™»å…¥</button>
                    </div>
                </div>
                <div id="quota-data-section" class="hidden">
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <p class="status-msg text-sky-600">Inventory Status</p>
                            <span id="quota-last-updated" class="text-[8px] text-slate-400 font-mono">--</span>
                        </div>
                        <button onclick="requestResetData()" class="text-[9px] text-rose-500 font-bold bg-rose-50 px-3 py-1 rounded-lg">æ¸…ç©ºç´€éŒ„</button>
                    </div>
                    <div id="quota-content" class="space-y-4">
                        <p class="text-center text-[10px] text-slate-400 italic py-10">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 2: DRAWING -->
        <div id="step-draw" class="hidden-step text-center py-10">
            <div class="flex justify-between items-center mb-10">
                <button id="btn-draw-back" onclick="goBackToSelection()" class="btn-back">â¬… è¿”å›å½©æ± </button>
                <div id="pool-badge" class="px-5 py-1.5 rounded-full bg-sky-600 text-white text-[10px] font-black uppercase shadow-lg">çµ„åˆ¥</div>
            </div>
            
            <div class="gacha-container mb-12" id="gacha-machine">
                <div class="gacha-glass"><div class="gacha-balls-container" id="balls-container"></div></div>
                <div class="gacha-base">
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
                        <div class="gacha-knob" onclick="spinGacha()">ğŸ’®</div>
                    </div>
                    <div class="absolute bottom-4 left-1/2 -translate-x-1/2 w-20 h-10 bg-black/20 rounded-lg"></div>
                </div>
                <div id="dropped-ball" class="dropped-ball"></div>
            </div>
            
            <button id="spin-btn" onclick="spinGacha()" class="btn-impact animate-pulse">é»æ“Šè½‰å‹•</button>
        </div>

        <!-- RESULT MODAL -->
        <div id="result-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-xl flex items-center justify-center p-6 z-50 hidden">
            <div class="glass-card p-8 max-w-md w-full text-center">
                <div class="text-5xl mb-6">ğŸŒ¸</div>
                <h3 class="status-msg text-sky-600 tracking-widest">ğŸ‰ æ­å–œæ‚¨ç²å¾—</h3>
                <p class="text-2xl font-black text-slate-800 mb-8" id="prize-text">çå“</p>
                
                <div class="space-y-4 mb-8 text-left">
                    <div class="text-[10px] font-mono text-slate-400 text-center" id="draw-time-display">--</div>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="input-mmc" oninput="checkFormValidity()" placeholder="MMC No." class="px-4 py-3 rounded-xl text-sm border bg-slate-50 border-slate-200 outline-none w-full">
                        <input type="text" id="input-invoice" oninput="checkFormValidity()" placeholder="Inv No." class="px-4 py-3 rounded-xl text-sm border bg-slate-50 border-slate-200 outline-none w-full">
                    </div>
                    <select id="input-cse" onchange="checkFormValidity()" class="w-full px-4 py-3 rounded-xl text-sm border bg-slate-50 border-slate-200 outline-none">
                        <option value="">è² è²¬åŒäº‹ (CSE)...</option>
                        <option value="miko.ngan">miko.ngan</option><option value="karykwong">karykwong</option><option value="angel.leungsl">angel.leungsl</option><option value="Helen.hui">Helen.hui</option><option value="sammi.ng">sammi.ng</option><option value="rania.lam">rania.lam</option><option value="winslee.hui">winslee.hui</option><option value="angela.chanhs">angela.chanhs</option><option value="aislin.hui">aislin.hui</option><option value="niki.ng">niki.ng</option><option value="yannux.man">yannux.man</option><option value="crystal.chanhy">crystal.chanhy</option><option value="rebecca.lam">rebecca.lam</option><option value="zoe.sohy">zoe.sohy</option><option value="joanne.chancy">joanne.chancy</option><option value="karena.leung.wt">karena.leung.wt</option><option value="miko.chen">miko.chen</option><option value="abbie.wong.kn">abbie.wong.kn</option><option value="michelle.choi">michelle.choi</option><option value="miki.wong">miki.wong</option><option value="Chrissie.wong">Chrissie.wong</option><option value="fanky.lam">fanky.lam</option><option value="milky.chong">milky.chong</option><option value="winnie.mowy">winnie.mowy</option><option value="ebbie.tam">ebbie.tam</option><option value="sharon.chu">sharon.chu</option><option value="wing.Chau">wing.Chau</option><option value="Angela.ChanHY">Angela.ChanHY</option><option value="Daisy.Wong">Daisy.Wong</option><option value="yandy.lee">yandy.lee</option>
                    </select>
                </div>
                
                <div id="submit-status" class="text-xs mb-4 hidden font-bold text-emerald-600"></div>
                <button id="submit-record-btn" onclick="submitDrawRecord()" class="w-full btn-impact py-4 rounded-2xl">æäº¤å­˜æª”</button>
            </div>
        </div>

        <!-- RESET MODAL -->
        <div id="reset-confirm-modal" class="hidden fixed inset-0 bg-slate-900/90 z-[100] flex items-center justify-center p-6">
            <div class="bg-white rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl">
                <h4 class="text-xl font-bold mb-4">ç¢ºèªæ¸…ç©ºé›²ç«¯ç´€éŒ„ï¼Ÿ</h4>
                <p class="text-sm text-slate-500 mb-6 italic">æ­¤æ“ä½œä¸å¯æ’¤éŠ·ã€‚è«‹è¼¸å…¥ "RESET"ã€‚</p>
                <input type="text" id="reset-type-input" oninput="validateDoubleConfirm()" placeholder="RESET" class="w-full px-4 py-3 rounded-xl border-2 text-center font-bold mb-4 outline-none">
                <div id="reset-error-msg" class="text-rose-500 text-[10px] font-bold mb-4 hidden"></div>
                <div class="space-y-2">
                    <button id="final-reset-btn" onclick="executeDataReset()" disabled class="w-full py-4 bg-slate-200 text-slate-400 font-bold rounded-xl cursor-not-allowed">ç¢ºèªæ¸…ç©º</button>
                    <button onclick="closeResetModal()" class="w-full py-2 text-slate-400 font-bold">è¿”å›</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, getDocs, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const scriptURL = "https://script.google.com/macros/s/AKfycbzlAeK5KjuT1qoF5N_ngdXVGzmvfTdwtOz0ge1Y0XrHa7Y-vjBdrqoCMWjkB8eULfrs/exec"; 
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'neoderm-spring-2026';
        
        let app, auth, db, user = null, lastPrize = "", selectedKey = 'silver', currentPool = null, spinning = false, isQuotaUnlocked = false, quotaUnsubscribe = null;

        const pools = {
            gold: { id: 'gold', name: "æ˜¥æ—¥é‡‘æ±  (Premium)", prizes: [{ name: "Ulthera Prime Face", count: 1 }, { name: "High Pexo Face", count: 3 }, { name: "PN+", count: 5 }, { name: "Pico Face", count: 7 }, { name: "VT Face", count: 20 }, { name: "BBL Face", count: 20 }, { name: "Transkin M w/o Mask", count: 400 }, { name: "éš¨æ©Ÿç²¾é¸é†«ç¾ç”¢å“", count: 210 }], description: "æ¶ˆè²»é‡‘é¡é” $50,000 æˆ–ä»¥ä¸Šã€‚" },
            silver: { id: 'silver', name: "æ˜¥æ—¥éŠ€æ±  (Elite)", prizes: [{ name: "Pico Face", count: 3 }, { name: "VT Face", count: 30 }, { name: "BBL Face", count: 30 }, { name: "Transkin M w/o Mask", count: 400 }, { name: "éš¨æ©Ÿç²¾é¸é†«ç¾ç”¢å“", count: 440 }], description: "æ¶ˆè²»é‡‘é¡ä»‹ä¹ $30,000 è‡³ $49,999ã€‚" },
            bronze: { id: 'bronze', name: "æ˜¥æ—¥éŠ…æ±  (Standard)", prizes: [{ name: "VT Face", count: 50 }, { name: "BBL Face", count: 50 }, { name: "Transkin M w/o Mask", count: 500 }, { name: "éš¨æ©Ÿç²¾é¸é†«ç¾ç”¢å“", count: 700 }], description: "æ¶ˆè²»é‡‘é¡ä»‹ä¹ $15,000 è‡³ $29,999ã€‚" },
            birthday: { id: 'birthday', name: "ç”Ÿæ—¥å½©æ±  (Special)", prizes: [{ name: "$1,000ç™‚ç¨‹å· (æŠ˜å¯¦æ»¿$14,000)", count: 500 }, { name: "$800ç™‚ç¨‹å· (æŠ˜å¯¦æ»¿$12,000)", count: 500 }, { name: "$500ç™‚ç¨‹å· (æŠ˜å¯¦æ»¿$8,000)", count: 500 }], description: "é©ç”¨æ–¼ 2ã€3ã€4 æœˆä»½ç”Ÿæ—¥ä¹‹å®¢æˆ¶ã€‚" }
        };

        window.selectPool = (key) => {
            selectedKey = key;
            document.querySelectorAll('.pool-tab').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${key}`).classList.add('active');
            document.getElementById('pool-description').innerText = pools[key].description;
        };
        window.selectPool('silver');

        if (firebaseConfig) {
            app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app);
            const initAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
            };
            initAuth();
            onAuthStateChanged(auth, u => { 
                user = u; 
                // Auto-start listener if password was already verified
                if (user && isQuotaUnlocked) startQuotaListener(); 
            });
        }

        window.checkFormValidity = () => {
            const valid = document.getElementById('input-mmc').value.trim() && document.getElementById('input-invoice').value.trim() && document.getElementById('input-cse').value;
            document.getElementById('submit-record-btn').style.opacity = valid ? "1" : "0.5";
        };

        window.toggleQuotaDashboard = () => {
            document.getElementById('quota-dashboard').classList.toggle('hidden');
        };

        window.verifyQuotaPassword = () => {
            if (document.getElementById('quota-password-input').value === "SoloTiff2004") {
                isQuotaUnlocked = true;
                document.getElementById('quota-auth-section').classList.add('hidden');
                document.getElementById('quota-data-section').classList.remove('hidden');
                // Trigger listener immediately
                startQuotaListener();
            } else {
                document.getElementById('quota-password-input').value = "";
            }
        };

        function startQuotaListener() {
            if (!db) return;
            // Display initial state immediately so it doesn't stay as "--"
            renderQuotaTable({});

            if (!user) {
                console.log("Waiting for user auth...");
                return;
            }

            if (quotaUnsubscribe) quotaUnsubscribe(); 

            quotaUnsubscribe = onSnapshot(
                collection(db, 'artifacts', appId, 'public', 'data', 'draw_records'), 
                snapshot => {
                    const wins = {}; 
                    snapshot.forEach(d => { 
                        const p = (d.data().prize || "").trim(); 
                        wins[p] = (wins[p] || 0) + 1; 
                    });
                    renderQuotaTable(wins);
                },
                err => {
                    console.error("Quota Listener Error:", err);
                    document.getElementById('quota-content').innerHTML = `<p class="text-[9px] text-rose-500 font-bold p-4 bg-white rounded">âŒ ç„¡æ³•é€£ç·šé›²ç«¯è³‡æ–™åº« (${err.code})</p>`;
                }
            );
        }

        function renderQuotaTable(wins) {
            let html = "";
            for (const pk in pools) {
                html += `<div class="mb-4">
                            <h4 class="text-[9px] font-black text-slate-800 mb-1 uppercase tracking-tight">${pools[pk].name}</h4>
                            <table class="quota-table"><tbody>`;
                pools[pk].prizes.forEach(p => {
                    const winCount = wins[p.name.trim()] || 0;
                    const rem = p.count - winCount;
                    html += `<tr class="text-[9px] font-medium">
                                <td class="text-slate-600">${p.name}</td>
                                <td class="text-right font-mono ${rem <= (p.count * 0.1) ? 'text-rose-600 font-bold' : 'text-slate-400'}">${rem} / ${p.count}</td>
                            </tr>`;
                });
                html += `</tbody></table></div>`;
            }
            document.getElementById('quota-content').innerHTML = html;
            document.getElementById('quota-last-updated').innerText = "LIVE SYNC: " + new Date().toLocaleTimeString();
        }

        window.requestResetData = () => { 
            document.getElementById('reset-type-input').value = ""; 
            document.getElementById('reset-confirm-modal').classList.remove('hidden'); 
        };
        window.closeResetModal = () => document.getElementById('reset-confirm-modal').classList.add('hidden');
        window.validateDoubleConfirm = () => {
            const ok = document.getElementById('reset-type-input').value.trim().toUpperCase() === "RESET";
            const b = document.getElementById('final-reset-btn');
            b.disabled = !ok; b.className = ok ? "w-full py-4 bg-rose-500 text-white font-bold rounded-xl shadow-lg cursor-pointer" : "w-full py-4 bg-slate-200 text-slate-400 font-bold rounded-xl cursor-not-allowed";
        };

        window.executeDataReset = async () => {
            if (!db || !user) return;
            const b = document.getElementById('final-reset-btn'); 
            b.disabled = true; b.innerText = "æ¸…ç©ºä¸­...";
            try {
                const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'draw_records'));
                const ps = []; 
                snap.forEach(d => ps.push(deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'draw_records', d.id))));
                await Promise.all(ps); 
                closeResetModal();
                b.innerText = "ç¢ºèªæ¸…ç©º";
            } catch (e) { 
                console.error(e);
                b.disabled = false; 
                b.innerText = "éŒ¯èª¤ï¼Œè«‹é‡è©¦"; 
            }
        };

        window.confirmEntry = () => {
            currentPool = pools[selectedKey];
            document.getElementById('step-eligibility').classList.add('hidden-step');
            document.getElementById('step-draw').classList.remove('hidden-step');
            document.getElementById('pool-badge').innerText = currentPool.name;
            setupGacha();
        };

        window.goBackToSelection = () => { if(!spinning) { document.getElementById('step-draw').classList.add('hidden-step'); document.getElementById('step-eligibility').classList.remove('hidden-step'); } };

        function setupGacha() {
            const container = document.getElementById('balls-container'); container.innerHTML = "";
            const colors = ['#fb7185', '#0ea5e9', '#ffffff', '#fbbf24', '#f472b6', '#7dd3fc'];
            for(let i=0; i<15; i++) {
                const ball = document.createElement('div'); ball.className = 'gacha-ball';
                ball.style.left = 15 + Math.random()*180 + 'px';
                ball.style.top = 40 + Math.random()*150 + 'px';
                ball.style.background = `radial-gradient(circle at 30% 30%, ${colors[i%colors.length]}, #0001)`;
                container.appendChild(ball);
            }
        }

        window.spinGacha = () => {
            if (spinning) return; spinning = true;
            const b = document.getElementById('spin-btn'), bb = document.getElementById('btn-draw-back');
            b.disabled = true; b.style.opacity = '0.5'; bb.style.visibility = 'hidden';
            
            const total = currentPool.prizes.reduce((s, p) => s + p.count, 0);
            let rnd = Math.random() * total, winIdx = 0, cur = 0;
            for (let i = 0; i < currentPool.prizes.length; i++) { cur += currentPool.prizes[i].count; if (rnd <= cur) { winIdx = i; break; } }
            lastPrize = currentPool.prizes[winIdx].name;

            document.getElementById('gacha-machine').classList.add('shaking');
            const j = setInterval(() => {
                document.querySelectorAll('.gacha-ball').forEach(bl => bl.style.transform = `translate(${(Math.random()-0.5)*25}px, ${(Math.random()-0.5)*25}px)`);
            }, 80);
            
            setTimeout(() => {
                clearInterval(j); document.getElementById('gacha-machine').classList.remove('shaking');
                const dbBall = document.getElementById('dropped-ball'); dbBall.style.display = 'block'; dbBall.style.background = `radial-gradient(circle at 30% 30%, #fb7185, #be123c)`;
                setTimeout(() => {
                    document.getElementById('prize-text').innerText = lastPrize;
                    document.getElementById('draw-time-display').innerText = new Date().toLocaleString('zh-HK');
                    document.getElementById('result-modal').classList.remove('hidden');
                    checkFormValidity(); spinning = false; bb.style.visibility = 'visible';
                }, 1000);
            }, 2000);
        };

        window.submitDrawRecord = async () => {
            const mmc = document.getElementById('input-mmc').value.trim(), inv = document.getElementById('input-invoice').value.trim(), cse = document.getElementById('input-cse').value;
            if (!mmc || !inv || !cse) return;
            const sb = document.getElementById('submit-record-btn'); 
            sb.disabled = true; sb.innerText = "å„²å­˜ä¸­...";
            const d = { mmc, invoice_no: inv, cse, prize: lastPrize, pool: currentPool.name, date_display: new Date().toLocaleString('zh-HK') };
            try {
                if (scriptURL) await fetch(scriptURL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(d) });
                if (db && user) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'draw_records'), { ...d, timestamp: serverTimestamp() });
                document.getElementById('submit-status').innerText = "âœ… æäº¤æˆåŠŸï¼"; 
                document.getElementById('submit-status').classList.remove('hidden');
                setTimeout(resetApp, 1500);
            } catch (e) { 
                console.error(e);
                setTimeout(resetApp, 1500); 
            }
        };

        window.resetApp = () => {
            document.getElementById('result-modal').classList.add('hidden');
            document.getElementById('step-draw').classList.add('hidden-step');
            document.getElementById('step-eligibility').classList.remove('hidden-step');
            document.getElementById('input-mmc').value = ""; document.getElementById('input-invoice').value = ""; document.getElementById('input-cse').selectedIndex = 0;
            document.getElementById('submit-status').classList.add('hidden');
            document.getElementById('spin-btn').disabled = false; document.getElementById('spin-btn').style.opacity = '1';
            document.getElementById('dropped-ball').style.display = 'none';
            document.getElementById('submit-record-btn').innerText = "æäº¤å­˜æª”";
        };

        // Sakura initialization
        const sc = document.getElementById('sakura-container');
        for (let i = 0; i < 20; i++) {
            const p = document.createElement('div'); p.className = 'petal';
            const sz = Math.random() * 8 + 6 + 'px'; p.style.width = sz; p.style.height = sz;
            p.style.left = Math.random() * 100 + 'vw'; p.style.top = '-20px';
            p.style.animationDuration = Math.random() * 5 + 4 + 's'; p.style.animationDelay = Math.random() * 5 + 's';
            sc.appendChild(p);
        }
    </script>
</body>
</html>
