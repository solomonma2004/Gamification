<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜¥æ—¥ç¾è‚Œç¶»æ”¾å¤§æŠ½ç - NeoDerm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --neo-rose: #ff4d6d;
            --neo-rose-dark: #c9184a;
            --neo-sky: #0ea5e9;
            --neo-sky-light: #bae6fd;
            --gold: #fbbf24;
        }

        body {
            font-family: 'Poppins', 'Noto Sans TC', sans-serif;
            background: linear-gradient(180deg, #e0f2fe 0%, #f0f9ff 40%, #fff5f7 100%);
            color: #1e293b;
            min-height: 100vh;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }

        /* Sakura Petals Effect */
        #sakura-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1;
        }

        .petal {
            position: absolute;
            background: linear-gradient(135deg, #ffdbed 0%, #ffb7d5 100%);
            border-radius: 150% 0 150% 50%;
            opacity: 0.7;
            transform-origin: center;
            animation: fall linear infinite;
        }

        @keyframes fall {
            0% { transform: translate(0, -10px) rotate(0deg) scale(1); }
            100% { transform: translate(150px, 100vh) rotate(720deg) scale(0.8); }
        }

        /* Banner Section Styling */
        .promotion-banner-container {
            width: 100vw; position: relative;
            left: 50%; right: 50%; margin-left: -50vw; margin-right: -50vw;
            margin-bottom: 2.5rem; line-height: 0;
        }

        .promotion-banner-img { width: 100%; height: auto; display: block; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }

        .grand-prize-banner {
            position: absolute; bottom: 8%; left: 50%; transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(3, 105, 161, 0.98) 0%, rgba(14, 165, 233, 0.95) 100%);
            backdrop-filter: blur(15px); color: white; padding: 18px 45px; border-radius: 120px;
            display: flex; align-items: center; gap: 24px;
            box-shadow: 0 20px 60px rgba(3, 105, 161, 0.5), inset 0 0 25px rgba(255, 255, 255, 0.3);
            animation: banner-float 3s infinite ease-in-out, shimmer-move 4s infinite linear;
            border: 4px solid rgba(255, 255, 255, 0.9); z-index: 20; width: fit-content; max-width: 95%;
            pointer-events: none; background-size: 200% auto;
        }

        .prize-icon-circle {
            background: white; width: 60px; height: 60px; min-width: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 2rem;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .prize-text-container { text-align: left; display: flex; flex-direction: column; justify-content: center; }
        .prize-label { font-size: 0.9rem; font-weight: 800; text-transform: uppercase; letter-spacing: 4px; margin-bottom: 2px; }
        .prize-main-row { display: flex; align-items: center; gap: 16px; }
        .prize-main-title { font-size: 2rem; font-weight: 900; letter-spacing: 0.5px; line-height: 1.1; text-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .prize-value-tag { background: white; color: #0369a1; padding: 4px 18px; border-radius: 40px; font-size: 1.1rem; font-weight: 900; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); border: 2px solid var(--gold); display: flex; align-items: center; gap: 4px; }
        .small-label { font-size: 0.7rem; font-weight: 600; opacity: 0.8; }

        @media (max-width: 768px) {
            .grand-prize-banner { padding: 12px 24px; gap: 14px; bottom: 6%; border-radius: 30px; }
            .prize-icon-circle { width: 44px; height: 44px; min-width: 44px; font-size: 1.4rem; }
            .prize-main-title { font-size: 1.2rem; }
            .prize-label { font-size: 0.7rem; letter-spacing: 2px; }
            .prize-value-tag { font-size: 0.85rem; padding: 4px 12px; }
            .prize-main-row { gap: 8px; flex-wrap: wrap; }
        }

        @keyframes banner-float { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-10px); } }
        @keyframes shimmer-move { 0% { background-position: 0% center; } 100% { background-position: 200% center; } }

        /* Gacha Machine UI */
        .gacha-container { position: relative; width: 320px; height: 460px; margin: 0 auto; }
        .gacha-glass {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 290px; height: 290px;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.6) 0%, rgba(186, 230, 253, 0.3) 100%);
            border: 10px solid white; border-radius: 50%; backdrop-filter: blur(1px); overflow: hidden;
            box-shadow: inset 0 10px 40px rgba(255,255,255,0.8), 0 20px 50px rgba(0,0,0,0.1);
            z-index: 5;
        }

        .gacha-glass::after {
            content: ''; position: absolute; top: 12%; left: 18%; width: 45px; height: 90px;
            background: rgba(255,255,255,0.4); border-radius: 50%; transform: rotate(40deg);
        }

        .gacha-balls-container { position: absolute; width: 100%; height: 100%; }
        .gacha-ball { position: absolute; width: 50px; height: 50px; border-radius: 50%; box-shadow: inset -4px -4px 12px rgba(0,0,0,0.15), 0 5px 12px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.6); }

        .gacha-base {
            position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 250px; height: 200px; background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%);
            border-radius: 30px 30px 60px 60px; z-index: 4; box-shadow: 0 15px 40px rgba(0,0,0,0.25); border: 5px solid var(--gold);
        }

        .gacha-base::before { content: 'ğŸŒ¸'; position: absolute; top: 15px; left: 20px; font-size: 1.5rem; }
        .gacha-base::after { content: 'ğŸŒ¸'; position: absolute; bottom: 60px; right: 20px; font-size: 1.2rem; opacity: 0.7; }

        .gacha-knob-area { position: absolute; top: 35px; left: 50%; transform: translateX(-50%); width: 90px; height: 90px; background: rgba(0,0,0,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .gacha-knob { width: 70px; height: 70px; background: radial-gradient(circle, #fbbf24 0%, #d97706 100%); border-radius: 50%; border: 4px solid #92400e; box-shadow: 0 6px 12px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.6s cubic-bezier(0.45, 0.05, 0.55, 0.95); }
        .gacha-knob::after { content: 'ğŸ’®'; font-size: 1.8rem; color: #78350f; }

        .gacha-slot { position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); width: 100px; height: 55px; background: linear-gradient(to bottom, #082f49, #0c4a6e); border-radius: 12px; box-shadow: inset 0 8px 20px rgba(0,0,0,0.6); border: 2px solid rgba(251, 113, 133, 0.4); }

        @keyframes rumble { 0%, 100% { transform: translateX(-50%) translateY(0); } 25% { transform: translateX(-51%) translateY(2px); } 75% { transform: translateX(-49%) translateY(-2px); } }
        .shaking .gacha-glass { animation: rumble 0.12s infinite; }

        .dropped-ball {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            width: 44px; height: 44px; border-radius: 50%; z-index: 10;
            border: 2px solid white; box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            animation: gacha-drop 1.2s cubic-bezier(0.17, 0.67, 0.83, 0.67) forwards;
            display: none;
        }

        @keyframes gacha-drop { 0% { transform: translate(-50%, -190px) scale(0.4); opacity: 0; } 40% { transform: translate(-50%, -15px) scale(1.1); opacity: 1; } 100% { transform: translate(-50%, 65px) scale(1); opacity: 1; } }

        /* UI Framework Styling */
        .glass-panel { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(15px); border: 1px solid white; border-radius: 32px; box-shadow: 0 15px 45px rgba(0, 0, 0, 0.05); position: relative; z-index: 5; }
        .neo-gradient-text { background: linear-gradient(135deg, #ff006e 0%, #ff5c8a 50%, #ff85a2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; filter: drop-shadow(0 2px 4px rgba(255, 0, 110, 0.2)); }
        
        .pool-tab { transition: all 0.3s ease; border: 3px solid transparent; cursor: pointer; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; }
        .tab-birthday { background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 25%, #fbc2eb 50%, #a1c4fd 75%, #c2e9fb 100%) !important; color: #be123c !important; }
        .tab-birthday.active { border-color: #f472b6 !important; box-shadow: 0 0 20px rgba(244, 114, 182, 0.4); }
        .tab-gold { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%) !important; color: #78350f !important; }
        .tab-gold.active { border-color: #d97706 !important; box-shadow: 0 0 20px rgba(217, 119, 6, 0.4); }
        .tab-silver { background: linear-gradient(135deg, #bdc3c7 0%, #ffffff 50%, #95a5a6 100%) !important; color: #2c3e50 !important; }
        .tab-silver.active { border-color: #7f8c8d !important; box-shadow: 0 0 20px rgba(127, 140, 141, 0.4); }
        .tab-bronze { background: linear-gradient(135deg, #d98b5f 0%, #ffcba4 50%, #a0522d 100%) !important; color: #ffffff !important; }
        .tab-bronze.active { border-color: #8b4513 !important; box-shadow: 0 0 20px rgba(139, 69, 19, 0.4); }

        .hidden-step { display: none; }
        .btn-neo { background: linear-gradient(135deg, #0369a1 0%, #0ea5e9 100%); color: white; transition: all 0.3s ease; box-shadow: 0 8px 20px rgba(14, 165, 233, 0.3); font-weight: 700; }
        .btn-neo:hover:not(:disabled) { transform: translateY(-2px); filter: brightness(1.1); }

        .quota-table { width: 100%; font-size: 0.8rem; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; }
        .quota-table th { background: #f0f9ff; padding: 10px; text-align: left; color: #0369a1; border-bottom: 2px solid #bae6fd; }
        .quota-table td { padding: 10px; border-bottom: 1px solid #f1f5f9; color: #475569; }
        .status-low { color: #ff4d6d !important; font-weight: 900; background: #fff1f2; }
        
        .btn-back { display: inline-flex; align-items: center; gap: 6px; color: #64748b; font-size: 0.75rem; font-weight: 700; padding: 6px 12px; border-radius: 12px; cursor: pointer; transition: all 0.2s; background: rgba(255,255,255,0.5); border: 1px solid rgba(255,255,255,0.8); }
        .btn-back:hover { color: #0ea5e9; background: white; transform: translateX(-3px); }
    </style>
</head>
<body>
    <div id="sakura-container"></div>

    <div class="max-w-4xl mx-auto relative z-10 pb-10">
        <header class="text-center">
            <div class="promotion-banner-container">
                <div class="grand-prize-banner">
                    <div class="prize-icon-circle">ğŸ’</div>
                    <div class="prize-text-container">
                        <span class="prize-label">çµ‚æ¥µå¤§ç æœ‰æ©Ÿæœƒè´å–</span>
                        <div class="prize-main-row">
                            <span class="prize-main-title">Ultherapy ç™‚ç¨‹ä¸€æ¬¡</span>
                            <span class="prize-value-tag"><span class="small-label">åƒ¹å€¼</span> $32,888</span>
                        </div>
                    </div>
                </div>
                <img src="https://image2url.com/r2/default/images/1772197034322-b5062db0-1c7c-4337-a113-a1e0f9b526ff.jpeg" class="promotion-banner-img" alt="Banner">
            </div>
            <div class="px-4 mb-6">
                <h1 class="text-5xl md:text-7xl neo-gradient-text mb-4 tracking-tight">æ˜¥æ—¥ç¾è‚Œç¶»æ”¾å¤§æŠ½ç</h1>
                <p class="text-sky-700 font-bold text-lg md:text-xl">æ¨å»£æœŸï¼šå³æ—¥è‡³ 2026å¹´3æœˆ31æ—¥</p>
            </div>
        </header>

        <!-- STEP 1: POOL SELECTION -->
        <div id="step-eligibility" class="glass-panel p-6 md:p-8 max-w-4xl mx-auto mb-8 mx-4">
            <h2 class="text-lg font-bold mb-6 text-center text-slate-700 text-shadow-sm">è«‹é¸æ“‡å®¢æˆ¶å°æ‡‰å½©æ± :</h2>
            
            <!-- ROW 1: Spending Pools -->
            <div class="grid grid-cols-3 gap-3 mb-6">
                <button onclick="selectPool('gold')" id="tab-gold" class="pool-tab tab-gold p-3 md:p-4 rounded-2xl shadow-md">
                    <span class="font-bold text-xs md:text-sm text-center">âœ¨ æ˜¥æ—¥é‡‘æ± </span>
                    <span class="text-[8px] md:text-[10px] font-bold opacity-80">>= $50K</span>
                </button>
                <button onclick="selectPool('silver')" id="tab-silver" class="pool-tab tab-silver p-3 md:p-4 rounded-2xl active shadow-md">
                    <span class="font-bold text-xs md:text-sm text-center">ğŸ¥ˆ æ˜¥æ—¥éŠ€æ± </span>
                    <span class="text-[8px] md:text-[10px] font-bold opacity-80">$30K-49K</span>
                </button>
                <button onclick="selectPool('bronze')" id="tab-bronze" class="pool-tab tab-bronze p-3 md:p-4 rounded-2xl shadow-md">
                    <span class="font-bold text-xs md:text-sm text-center">ğŸ¥‰ æ˜¥æ—¥éŠ…æ± </span>
                    <span class="text-[8px] md:text-[10px] font-bold opacity-80">$15K-29K</span>
                </button>
            </div>

            <!-- ROW 2: Birthday Pool (Next Row) -->
            <div class="flex justify-center mb-8">
                <button onclick="selectPool('birthday')" id="tab-birthday" class="pool-tab tab-birthday w-full max-w-md p-4 rounded-2xl shadow-lg border-2 border-transparent">
                    <span class="font-bold text-base text-center">ğŸ‚ ç”Ÿæ—¥å½©æ± </span>
                    <span class="text-[10px] font-bold opacity-80">2/3/4 æœˆç”Ÿæ—¥ç‰¹åˆ¥çå‹µ</span>
                </button>
            </div>

            <div class="bg-white/60 p-4 rounded-2xl mb-8 border border-white/80 shadow-inner min-h-[50px] flex items-center justify-center text-center">
                <p id="pool-description" class="text-slate-600 text-xs font-medium italic">è¼‰å…¥ä¸­...</p>
            </div>
            <button onclick="confirmEntry()" class="w-full py-4 rounded-2xl btn-neo font-bold text-xl uppercase tracking-widest">é€²å…¥æŠ½ç</button>
            
            <button onclick="toggleQuotaDashboard()" class="w-full mt-6 text-slate-400 text-[10px] font-bold uppercase tracking-widest hover:text-sky-500 transition-colors">
                ğŸ“Š çå“é…é¡å³æ™‚æ¦‚æ³ (å…§éƒ¨åƒè€ƒ)
            </button>
            
            <div id="quota-dashboard" class="hidden mt-4 bg-white/50 rounded-2xl p-4 border border-white/50 overflow-hidden shadow-inner">
                <div id="quota-auth-section" class="text-center py-2">
                    <p class="text-[10px] text-slate-500 font-bold mb-3 uppercase">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼</p>
                    <div class="flex gap-2 max-w-xs mx-auto">
                        <input type="password" id="quota-password-input" placeholder="Password" class="flex-1 px-3 py-2 rounded-xl text-sm border-none focus:ring-2 focus:ring-sky-400">
                        <button onclick="verifyQuotaPassword()" class="bg-sky-500 text-white px-4 py-2 rounded-xl text-xs font-bold">é©—è­‰</button>
                    </div>
                </div>
                <div id="quota-data-section" class="hidden">
                    <div class="flex justify-between items-center mb-4 border-b border-slate-200 pb-2">
                        <div>
                            <h3 class="text-[10px] font-bold text-sky-700 uppercase">å‰©é¤˜é…é¡ (å¯¦æ™‚åŒæ­¥)</h3>
                            <span id="quota-last-updated" class="text-[8px] text-slate-400 font-mono block">--</span>
                        </div>
                        <button onclick="requestResetData()" class="text-[10px] text-rose-400 font-bold hover:underline">âš ï¸ é‡ç½®æ•¸æ“š</button>
                    </div>
                    <div id="quota-content" class="max-h-[350px] overflow-y-auto">
                        <p class="text-center text-[10px] text-slate-400 py-10 italic">æ­£åœ¨ç²å–é›²ç«¯æ•¸æ“š...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 2: DRAWING -->
        <div id="step-draw" class="hidden-step text-center py-6 px-4">
            <div class="flex justify-between items-center mb-6 max-w-xs mx-auto">
                <button id="btn-draw-back" onclick="goBackToSelection()" class="btn-back"><span>â¬…</span> è¿”å›é‡é¸</button>
                <div id="pool-badge" class="inline-block px-4 py-1 rounded-full border border-sky-200 bg-white/80 text-sky-600 text-[10px] font-bold uppercase shadow-sm">çµ„åˆ¥</div>
            </div>
            <h2 class="text-2xl font-bold mb-8 text-slate-800">è«‹æŒ‰æŒ‰éˆ•é€²è¡ŒæŠ½ç</h2>
            <div class="gacha-container" id="gacha-machine">
                <div class="gacha-glass"><div class="gacha-balls-container" id="balls-container"></div></div>
                <div class="gacha-base"><div class="gacha-knob-area"><div class="gacha-knob" onclick="spinGacha()"></div></div><div class="gacha-slot"></div></div>
                <div id="dropped-ball" class="dropped-ball"></div>
            </div>
            <button id="spin-btn" onclick="spinGacha()" class="mt-10 px-16 py-4 rounded-full btn-neo font-bold text-2xl animate-pulse shadow-xl">ç«‹å³æŠ½ç</button>
        </div>

        <!-- RESULT MODAL -->
        <div id="result-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-6 z-50 hidden overflow-y-auto">
            <div class="glass-panel p-6 max-w-md w-full border-white shadow-2xl">
                <div class="text-center mb-6">
                    <div class="text-5xl mb-2">ğŸŒ¸</div>
                    <h3 class="text-[10px] text-sky-500 font-bold uppercase mb-1">æ­å–œæ‚¨ï¼ä¸­çé …ç›®</h3>
                    <p class="text-xl font-bold text-slate-800" id="prize-text">çå“</p>
                </div>
                <div class="space-y-3 mb-6">
                    <div class="bg-slate-50 p-3 rounded-xl text-center border border-slate-100"><span id="draw-time-display" class="font-mono text-xs text-slate-500">--</span></div>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="input-mmc" oninput="checkFormValidity()" placeholder="MMC å®¢æˆ¶ç·¨è™Ÿ" class="w-full px-3 py-3 rounded-xl text-sm border">
                        <input type="text" id="input-invoice" oninput="checkFormValidity()" placeholder="Invoice ç·¨è™Ÿ" class="w-full px-3 py-3 rounded-xl text-sm border">
                    </div>
                    <select id="input-cse" onchange="checkFormValidity()" class="w-full px-3 py-3 rounded-xl text-sm cursor-pointer border bg-white">
                        <option value="">è² è²¬åŒäº‹ (CSE)...</option>
                        <option value="miko.ngan">miko.ngan</option>
                        <option value="karykwong">karykwong</option>
                        <option value="angel.leungsl">angel.leungsl</option>
                        <option value="Helen.hui">Helen.hui</option>
                        <option value="sammi.ng">sammi.ng</option>
                        <option value="rania.lam">rania.lam</option>
                        <option value="winslee.hui">winslee.hui</option>
                        <option value="angela.chanhs">angela.chanhs</option>
                        <option value="aislin.hui">aislin.hui</option>
                        <option value="niki.ng">niki.ng</option>
                        <option value="yannux.man">yannux.man</option>
                        <option value="crystal.chanhy">crystal.chanhy</option>
                        <option value="rebecca.lam">rebecca.lam</option>
                        <option value="zoe.sohy">zoe.sohy</option>
                        <option value="joanne.chancy">joanne.chancy</option>
                        <option value="karena.leung.wt">karena.leung.wt</option>
                        <option value="miko.chen">miko.chen</option>
                        <option value="abbie.wong.kn">abbie.wong.kn</option>
                        <option value="michelle.choi">michelle.choi</option>
                        <option value="miki.wong">miki.wong</option>
                        <option value="Chrissie.wong">Chrissie.wong</option>
                        <option value="fanky.lam">fanky.lam</option>
                        <option value="milky.chong">milky.chong</option>
                        <option value="winnie.mowy">winnie.mowy</option>
                        <option value="ebbie.tam">ebbie.tam</option>
                        <option value="sharon.chu">sharon.chu</option>
                        <option value="wing.Chau">wing.Chau</option>
                        <option value="Angela.ChanHY">Angela.ChanHY</option>
                        <option value="Daisy.Wong">Daisy.Wong</option>
                        <option value="yandy.lee">yandy.lee</option>
                    </select>
                </div>
                <div id="submit-status" class="text-center text-xs mb-4 hidden font-bold text-emerald-600"></div>
                <button id="submit-record-btn" onclick="submitDrawRecord()" class="w-full py-4 btn-neo rounded-2xl font-bold shadow-lg uppercase">æäº¤å­˜æª”</button>
                <button id="btn-back-to-start" onclick="resetApp()" style="display: none;" class="w-full mt-4 py-1 text-slate-400 hover:text-rose-500 text-[10px] font-bold">è¿”å›é‡æ–°é–‹å§‹</button>
            </div>
        </div>

        <!-- RESET CONFIRM -->
        <div id="reset-confirm-modal" class="hidden fixed inset-0 bg-slate-900/80 z-[100] flex items-center justify-center p-6">
            <div class="bg-white rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl">
                <div class="text-4xl mb-4">ğŸš¨</div>
                <h4 class="text-xl font-bold text-slate-800 mb-2">ç¢ºèªé‡ç½®æ•¸æ“šï¼Ÿ</h4>
                <p class="text-sm text-slate-500 mb-4 leading-relaxed">å°‡æ°¸ä¹…åˆªé™¤é›²ç«¯æ‰€æœ‰ç´€éŒ„ã€‚è¼¸å…¥ <span class="text-rose-500 font-bold">RESET</span> ä»¥ç¢ºèªã€‚</p>
                <div class="mb-4">
                    <input type="text" id="reset-type-input" oninput="validateDoubleConfirm()" placeholder="RESET" class="w-full px-4 py-3 rounded-xl border-2 text-center font-bold outline-none transition-all">
                </div>
                <div id="reset-error-msg" class="text-rose-500 text-[10px] font-bold mb-4 hidden"></div>
                <div class="flex flex-col gap-2">
                    <button id="final-reset-btn" onclick="executeDataReset()" disabled class="w-full py-4 bg-slate-200 text-slate-400 font-bold rounded-xl transition-all cursor-not-allowed">ç¢ºèªé‡ç½®æ•¸æ“š</button>
                    <button onclick="closeResetModal()" class="w-full py-2 text-slate-400 font-bold">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, getDocs, deleteDoc, doc, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const scriptURL = "https://script.google.com/macros/s/AKfycbzlAeK5KjuT1qoF5N_ngdXVGzmvfTdwtOz0ge1Y0XrHa7Y-vjBdrqoCMWjkB8eULfrs/exec"; 
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'neoderm-spring-2026';
        
        let app, auth, db, user = null, lastPrize = "", selectedKey = 'silver', currentPool = null, spinning = false, isQuotaUnlocked = false, quotaUnsubscribe = null;

        const pools = {
            gold: { id: 'gold', name: "æ˜¥æ—¥é‡‘æ±  (Premium)", prizes: [{ name: "Ulthera Prime Face", count: 1 }, { name: "High Pexo Face", count: 3 }, { name: "PN+", count: 5 }, { name: "Pico Face", count: 7 }, { name: "VT Face", count: 20 }, { name: "BBL Face", count: 20 }, { name: "Transkin M w/o Mask", count: 400 }, { name: "éš¨æ©Ÿç²¾é¸é†«ç¾ç”¢å“", count: 210 }], description: "é©ç”¨æ–¼æ¶ˆè²»é‡‘é¡é” $50,000 æˆ–ä»¥ä¸Šä¹‹å®¢æˆ¶ã€‚" },
            silver: { id: 'silver', name: "æ˜¥æ—¥éŠ€æ±  (Elite)", prizes: [{ name: "Pico Face", count: 3 }, { name: "VT Face", count: 30 }, { name: "BBL Face", count: 30 }, { name: "Transkin M w/o Mask", count: 400 }, { name: "éš¨æ©Ÿç²¾é¸é†«ç¾ç”¢å“", count: 440 }], description: "é©ç”¨æ–¼æ¶ˆè²»é‡‘é¡ä»‹ä¹ $30,000 è‡³ $49,999 ä¹‹å®¢æˆ¶ã€‚" },
            bronze: { id: 'bronze', name: "æ˜¥æ—¥éŠ…æ±  (Standard)", prizes: [{ name: "VT Face", count: 50 }, { name: "BBL Face", count: 50 }, { name: "Transkin M w/o Mask", count: 500 }, { name: "éš¨æ©Ÿç²¾é¸é†«ç¾ç”¢å“", count: 700 }], description: "é©ç”¨æ–¼æ¶ˆè²»é‡‘é¡ä»‹ä¹ $15,000 è‡³ $29,999 ä¹‹å®¢æˆ¶ã€‚" },
            birthday: { id: 'birthday', name: "ç”Ÿæ—¥å½©æ±  (Special)", prizes: [{ name: "$1,000ç™‚ç¨‹å· (æŠ˜å¯¦æ»¿$14,000)", count: 500 }, { name: "$800ç™‚ç¨‹å· (æŠ˜å¯¦æ»¿$12,000)", count: 500 }, { name: "$500ç™‚ç¨‹å· (æŠ˜å¯¦æ»¿$8,000)", count: 500 }], description: "é©ç”¨æ–¼ 2ã€3ã€4 æœˆä»½ç”Ÿæ—¥ä¹‹å®¢æˆ¶ã€‚" }
        };

        window.selectPool = (key) => {
            selectedKey = key;
            document.querySelectorAll('.pool-tab').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById(`tab-${key}`);
            if(btn) btn.classList.add('active');
            document.getElementById('pool-description').innerText = pools[key].description;
        };
        window.selectPool('silver');

        if (firebaseConfig) {
            app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app);
            const initAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
            };
            initAuth();
            onAuthStateChanged(auth, u => { 
                user = u; 
                if (user && isQuotaUnlocked) startQuotaListener(); 
            });
        }

        window.checkFormValidity = () => {
            const valid = document.getElementById('input-mmc').value.trim() && document.getElementById('input-invoice').value.trim() && document.getElementById('input-cse').value;
            const btn = document.getElementById('btn-back-to-start');
            if(btn) btn.style.display = valid ? "block" : "none";
        };

        window.toggleQuotaDashboard = () => {
            document.getElementById('quota-dashboard').classList.toggle('hidden');
            if (!document.getElementById('quota-dashboard').classList.contains('hidden') && isQuotaUnlocked) startQuotaListener();
        };

        window.verifyQuotaPassword = () => {
            if (document.getElementById('quota-password-input').value === "SoloTiff2004") {
                isQuotaUnlocked = true;
                document.getElementById('quota-auth-section').classList.add('hidden');
                document.getElementById('quota-data-section').classList.remove('hidden');
                startQuotaListener();
            } else document.getElementById('quota-password-input').value = "";
        };

        function startQuotaListener() {
            if (!db || !user) return;
            if (quotaUnsubscribe) quotaUnsubscribe(); 

            quotaUnsubscribe = onSnapshot(
                collection(db, 'artifacts', appId, 'public', 'data', 'draw_records'), 
                snapshot => {
                    const wins = {}; 
                    snapshot.forEach(d => { 
                        const p = (d.data().prize || "").trim(); 
                        wins[p] = (wins[p] || 0) + 1; 
                    });

                    let html = "";
                    for (const pk in pools) {
                        html += `<div class="mb-6 text-left"><h4 class="text-[11px] font-extrabold text-sky-600 mb-2 flex items-center gap-2"><span class="w-1.5 h-1.5 rounded-full bg-sky-500"></span>${pools[pk].name}</h4><table class="quota-table"><thead><tr><th>çå“</th><th>å‰©é¤˜/ç¸½æ•¸</th></tr></thead><tbody>`;
                        pools[pk].prizes.forEach(p => {
                            const winCount = wins[p.name.trim()] || 0;
                            const rem = p.count - winCount;
                            html += `<tr><td>${p.name}</td><td class="${rem <= (p.count * 0.1) ? 'status-low' : ''}">${rem} / ${p.count}</td></tr>`;
                        });
                        html += `</tbody></table></div>`;
                    }
                    document.getElementById('quota-content').innerHTML = html;
                    document.getElementById('quota-last-updated').innerText = "æœ€å¾ŒåŒæ­¥: " + new Date().toLocaleTimeString();
                },
                error => {
                    document.getElementById('quota-content').innerHTML = `<p class="text-center text-[10px] text-rose-500 py-10 font-bold uppercase tracking-widest">æ•¸æ“šåº«é€£æ¥å¤±æ•—: ${error.code}</p>`;
                }
            );
        }

        window.requestResetData = () => { 
            document.getElementById('reset-type-input').value = ""; 
            document.getElementById('reset-error-msg').classList.add('hidden');
            validateDoubleConfirm(); 
            document.getElementById('reset-confirm-modal').classList.remove('hidden'); 
        };
        window.closeResetModal = () => document.getElementById('reset-confirm-modal').classList.add('hidden');
        window.validateDoubleConfirm = () => {
            const ok = document.getElementById('reset-type-input').value.trim().toUpperCase() === "RESET";
            const b = document.getElementById('final-reset-btn');
            b.disabled = !ok; b.className = ok ? "w-full py-4 bg-rose-500 text-white font-bold rounded-xl shadow-lg cursor-pointer" : "w-full py-4 bg-slate-200 text-slate-400 font-bold rounded-xl cursor-not-allowed";
        };

        window.executeDataReset = async () => {
            if (!db) return;
            if (!user) {
                document.getElementById('reset-error-msg').innerText = "âŒ æœªç™»éŒ„ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦";
                document.getElementById('reset-error-msg').classList.remove('hidden');
                return;
            }

            const b = document.getElementById('final-reset-btn'); 
            const errorEl = document.getElementById('reset-error-msg');
            b.disabled = true; b.innerText = "æ¸…é™¤ä¸­...";
            errorEl.classList.add('hidden');

            try {
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'draw_records');
                const snap = await getDocs(colRef);
                
                if (snap.empty) {
                    b.innerText = "å®Œæˆ (ç„¡æ•¸æ“š)";
                    setTimeout(closeResetModal, 1000);
                    return;
                }

                const ps = []; 
                snap.forEach(d => {
                    ps.push(deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'draw_records', d.id)));
                });
                
                await Promise.all(ps); 
                b.innerText = "é‡ç½®æˆåŠŸï¼";
                setTimeout(() => {
                    closeResetModal();
                    b.innerText = "ç¢ºèªé‡ç½®æ•¸æ“š";
                }, 1500);
            } catch (e) { 
                console.error("Reset Error:", e);
                b.disabled = false; 
                b.innerText = "é‡è©¦"; 
                errorEl.innerText = `âŒ éŒ¯èª¤: ${e.code || "é€£ç·šå¤±æ•—"}`;
                errorEl.classList.remove('hidden');
            }
        };

        window.confirmEntry = () => {
            currentPool = pools[selectedKey];
            document.getElementById('step-eligibility').classList.add('hidden-step');
            document.getElementById('step-draw').classList.remove('hidden-step');
            document.getElementById('pool-badge').innerText = currentPool.name;
            setupGacha();
        };

        window.goBackToSelection = () => { if(!spinning) { document.getElementById('step-draw').classList.add('hidden-step'); document.getElementById('step-eligibility').classList.remove('hidden-step'); } };

        function setupGacha() {
            const container = document.getElementById('balls-container'); container.innerHTML = "";
            const colors = ['#fb7185', '#0ea5e9', '#ffffff', '#fbbf24', '#f472b6', '#7dd3fc'];
            for(let i=0; i<20; i++) {
                const ball = document.createElement('div'); ball.className = 'gacha-ball';
                ball.style.left = 15 + Math.random()*220 + 'px';
                ball.style.top = 60 + Math.random()*150 + 'px';
                ball.style.background = `radial-gradient(circle at 30% 30%, ${colors[i%colors.length]}, #0002)`;
                ball.style.zIndex = Math.floor(Math.random()*10);
                container.appendChild(ball);
            }
        }

        window.spinGacha = () => {
            if (spinning) return; spinning = true;
            const b = document.getElementById('spin-btn'), bb = document.getElementById('btn-draw-back');
            b.disabled = true; b.style.opacity = '0.5'; bb.style.visibility = 'hidden';
            
            const total = currentPool.prizes.reduce((s, p) => s + p.count, 0);
            let rnd = Math.random() * total, winIdx = 0, cur = 0;
            for (let i = 0; i < currentPool.prizes.length; i++) { cur += currentPool.prizes[i].count; if (rnd <= cur) { winIdx = i; break; } }
            lastPrize = currentPool.prizes[winIdx].name;

            document.getElementById('gacha-machine').classList.add('shaking');
            const j = setInterval(() => {
                document.querySelectorAll('.gacha-ball').forEach(bl => bl.style.transform = `translate(${(Math.random()-0.5)*35}px, ${(Math.random()-0.5)*35}px)`);
            }, 80);
            
            setTimeout(() => {
                clearInterval(j); document.getElementById('gacha-machine').classList.remove('shaking');
                const dbBall = document.getElementById('dropped-ball'); dbBall.style.display = 'block'; dbBall.style.background = `radial-gradient(circle at 30% 30%, #fb7185, #be123c)`;
                setTimeout(() => {
                    document.getElementById('prize-text').innerText = lastPrize;
                    document.getElementById('draw-time-display').innerText = new Date().toLocaleString('zh-HK');
                    document.getElementById('result-modal').classList.remove('hidden');
                    checkFormValidity(); spinning = false; bb.style.visibility = 'visible';
                }, 1100);
            }, 3000);
        };

        window.submitDrawRecord = async () => {
            const mmc = document.getElementById('input-mmc').value.trim(), inv = document.getElementById('input-invoice').value.trim(), cse = document.getElementById('input-cse').value;
            if (!mmc || !inv || !cse) return;
            const sb = document.getElementById('submit-record-btn'); sb.disabled = true; sb.innerText = "å„²å­˜ä¸­...";
            const d = { mmc, invoice_no: inv, cse, prize: lastPrize, pool: currentPool.name, date_display: new Date().toLocaleString('zh-HK') };
            try {
                if (scriptURL) await fetch(scriptURL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(d) });
                if (db && user) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'draw_records'), { ...d, timestamp: serverTimestamp() });
                document.getElementById('submit-status').innerText = "âœ… æäº¤æˆåŠŸï¼è³‡æ–™å·²åŒæ­¥ã€‚"; 
                document.getElementById('submit-status').classList.remove('hidden');
                setTimeout(resetApp, 1500);
            } catch (e) { setTimeout(resetApp, 1500); }
        };

        window.resetApp = () => {
            document.getElementById('result-modal').classList.add('hidden');
            document.getElementById('step-draw').classList.add('hidden-step');
            document.getElementById('step-eligibility').classList.remove('hidden-step');
            document.getElementById('input-mmc').value = ""; document.getElementById('input-invoice').value = ""; document.getElementById('input-cse').selectedIndex = 0;
            document.getElementById('submit-status').classList.add('hidden');
            document.getElementById('spin-btn').disabled = false; document.getElementById('spin-btn').style.opacity = '1';
            document.getElementById('dropped-ball').style.display = 'none';
        };

        const sc = document.getElementById('sakura-container');
        for (let i = 0; i < 35; i++) {
            const p = document.createElement('div'); p.className = 'petal';
            const sz = Math.random() * 12 + 8 + 'px'; p.style.width = sz; p.style.height = sz;
            p.style.left = Math.random() * 100 + 'vw'; p.style.top = '-20px';
            p.style.animationDuration = Math.random() * 5 + 5 + 's'; p.style.animationDelay = Math.random() * 10 + 's';
            sc.appendChild(p);
        }
    </script>
</body>
</html>
